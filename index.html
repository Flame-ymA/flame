<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto · 费用录入</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ sjgold:'#FFD700' } } } }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">费用录入（Sheet4 ⇢ 按日期列）</h1>
      <a href="query.html" class="text-sm opacity-75 hover:opacity-100">查询</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">

      <!-- 1) 选择车辆（Sheet5） -->
      <div>
        <label class="block text-sm mb-1">选择车辆（来自 Sheet5）<span class="text-sjgold">*</span></label>
        <select id="carSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"></select>
        <p class="mt-1 text-xs opacity-70">展示为：StockID · Year Make Model</p>
      </div>

      <!-- 2) 选择日期（表头）→ 月历网格 -->
      <div>
        <label class="block text.sm mb-2">日期（来自 Sheet4 表头）<span class="text-sjgold">*</span></label>

        <div class="flex items-center justify-between mb-2">
          <button id="calPrev" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">←</button>
          <div id="calTitle" class="text-sm font-semibold"></div>
          <button id="calNext" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">→</button>
        </div>

        <div class="grid grid-cols-7 text-xs opacity-70 mb-1">
          <div class="text-center py-1">Mon</div><div class="text-center py-1">Tue</div><div class="text-center py-1">Wed</div>
          <div class="text-center py-1">Thu</div><div class="text-center py-1">Fri</div><div class="text-center py-1">Sat</div><div class="text-center py-1">Sun</div>
        </div>

        <div id="calGrid" class="grid grid-cols-7 gap-1"></div>
        <input id="dateHdrRaw" type="hidden" />
        <p class="mt-2 text-xs opacity-70" id="calHint"></p>
      </div>

      <!-- 3) 费用类别 -->
      <div>
        <label class="block text-sm mb-1">费用类别<span class="text-sjgold">*</span></label>
        <select id="catSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="税前买入金额">税前买入金额</option>
          <option value="买断金额（lease）">买断金额（lease）</option>
          <option value="车主证过户费用">车主证过户费用</option>
          <option value="转lease费用/买断费用">转lease费用/买断费用</option>
          <option value="检修费用">检修费用</option>
          <option value="加油费用">加油费用</option>
          <option value="上牌费用">上牌费用</option>
          <option value="银行手续费">银行手续费</option>
          <option value="客户返佣">客户返佣</option>
          <option value="中介返佣">中介返佣</option>
          <option value="员工激励">员工激励</option>
        </select>
      </div>

      <!-- 4) 金额 -->
      <div>
        <label class="block text-sm mb-1">金额（CAD）<span class="text-sjgold">*</span></label>
        <input id="amount" type="number" step="0.01" min="0"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="例如 2800"/>
      </div>

      <!-- 备注（可选） -->
      <div>
        <label class="block text-sm mb-1">备注（可选）</label>
        <input id="note" type="text"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="如：贴膜 / 拖车费 …"/>
      </div>

      <!-- 5) 上传图片（可选，多选） -->
      <div class="space-y-2">
        <label class="block text-sm">上传图片（可多选）</label>
        <input id="imgFiles" type="file" accept="image/*" multiple
               class="block w-full text-sm file:mr-3 file:px-4 file:py-2 file:rounded-lg file:border-0 file:bg-sjgold file:text-black hover:file:brightness-95"/>
        <div class="flex items-center gap-2">
          <button type="button" id="btnUploadImgs"
                  class="inline-flex items-center justify-center gap-2 px-4 h-10 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900">
            上传到 Cloudinary
          </button>
          <span id="upMsg" class="text-xs opacity-80"></span>
        </div>
        <div id="upList" class="space-y-2 text-xs"></div>
        <div id="upPreview" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
      </div>

      <!-- 提交 -->
      <div class="pt-2">
        <button id="btnSubmit"
                class="inline-flex items-center justify-center gap-2 px-6 h-11 rounded-xl bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90">
          提交
        </button>
        <span id="msg" class="ml-3 text-sm opacity-80"></span>
      </div>
    </section>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    // ---------- 小工具 ----------
    const normalize = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const getCol = (headers, candidates) => {
      const map = headers.map(h => normalize(h));
      for (const c of candidates) {
        const i = map.indexOf(normalize(c));
        if (i !== -1) return i;
      }
      return -1;
    };

    // ✅ 放宽：保留中文、字母、数字、._-()；统一替换空白与竖线；禁止斜杠
    const toSlug = (s) => {
      const t = String(s || '')
        .trim()
        .replace(/（/g,'(').replace(/）/g,')')
        .replace(/[\/\\]+/g,'-')                // 斜杠当分隔符处理，避免进子目录
        .replace(/\s+/g,'-')                    // 空白 -> -
        .replace(/[|]+/g,'-')                   // 竖线 -> -
        .replace(/[^0-9A-Za-z_.\-()\u4e00-\u9fa5]/g,'-') // 保留中文
        .replace(/-+/g,'-')                     // 合并连续 -
        .replace(/^-|-$/g,'');                  // 去首尾 -
      return t || 'x';
    };

    const pad2 = (n) => String(n).padStart(2, '0');

    // ========== 初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadCarsFromSheet5();
      loadDatesFromSheet4();
      document.getElementById('btnSubmit').addEventListener('click', submitExpense);
      document.getElementById('calPrev').addEventListener('click', ()=>{ CAL_MONTH--; if(CAL_MONTH===0){CAL_MONTH=12;CAL_YEAR--;} renderCalendar(); });
      document.getElementById('calNext').addEventListener('click', ()=>{ CAL_MONTH++; if(CAL_MONTH===13){CAL_MONTH=1;CAL_YEAR++;} renderCalendar(); });
      document.getElementById('btnUploadImgs').addEventListener('click', uploadImagesForExpense);
    });

    // 1) 读 Sheet5 前四列→组合显示
    async function loadCarsFromSheet5(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet5 为空');
        const [header, ...rows] = values;

        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelect');
        sel.innerHTML = '';

        rows.forEach(row => {
          const stock = row[stockIdx] || '';
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          if(!stock) return;
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model});
          opt.textContent = `${stock} · ${year} ${make} ${model}`.trim();
          sel.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        document.getElementById('carSelect').innerHTML = '<option>加载失败</option>';
      }
    }

    // ========== 月历相关 ==========
    let S4_HEADERS_RAW = [];
    let S4_PARSED = [];
    let CAL_YEAR, CAL_MONTH;
    let SELECTED_HDR_RAW = '';

    function parseHeaderMD(h){
      const s = String(h||'').trim();
      let m = s.match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
      if(m) return { month:+m[1], day:+m[2] };
      const t = s.replace(/[.\-]/g,'/');
      m = t.match(/(\d{1,2})\/(\d{1,2})/);
      if(m) return { month:+m[1], day:+m[2] };
      if(/^\d{1,2}$/.test(s)) return { month:null, day:+s };
      return { month:null, day:null };
    }

    async function loadDatesFromSheet4(){
      try{
        const r = await fetch(`${BACKEND}/sheet4`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet4 为空');
        const header = values[0] || [];

        S4_HEADERS_RAW = header.slice(1).map(v => String(v||'').trim());
        S4_PARSED = S4_HEADERS_RAW.map(raw => ({ raw, ...parseHeaderMD(raw) }));

        const today = new Date();
        CAL_YEAR = today.getFullYear();

        const months = S4_PARSED.map(x=>x.month).filter(m=>m!=null);
        CAL_MONTH = months.length === 0 ? (today.getMonth()+1)
                  : (months.includes(today.getMonth()+1) ? (today.getMonth()+1) : months[0]);

        renderCalendar();
        autoPickToday();
      }catch(e){
        console.error(e);
        document.getElementById('calGrid').innerHTML =
          '<div class="col-span-7 text-center py-6 opacity-70">日期加载失败</div>';
      }
    }

    function renderCalendar(){
      const grid  = document.getElementById('calGrid');
      const title = document.getElementById('calTitle');
      const hint  = document.getElementById('calHint');

      if (!CAL_YEAR || !CAL_MONTH) {
        const t = new Date();
        CAL_YEAR  = CAL_YEAR  || t.getFullYear();
        CAL_MONTH = CAL_MONTH || (t.getMonth() + 1);
      }
      title.textContent = `${CAL_YEAR}-${String(CAL_MONTH).padStart(2,'0')}`;

      const first = new Date(CAL_YEAR, CAL_MONTH-1, 1);
      const startCol = (first.getDay()+6)%7;
      const days = new Date(CAL_YEAR, CAL_MONTH, 0).getDate();

      grid.innerHTML = '';
      for(let i=0;i<startCol;i++) grid.appendChild(document.createElement('div'));

      for(let d=1; d<=days; d++){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='relative w-full aspect-square rounded-lg border border-sjgold/20 hover:border-sjgold/50 text-sm';

        const match = S4_PARSED.find(x => x.month===CAL_MONTH && x.day===d)
                   || S4_PARSED.find(x => x.month==null && x.day===d);
        btn.textContent = d;
        if(match){
          btn.onclick = ()=>selectHeaderRaw(match.raw);
          if(SELECTED_HDR_RAW && match.raw===SELECTED_HDR_RAW)
            btn.classList.add('bg-sjgold','text-black','font-semibold');
        }else{
          btn.classList.add('opacity-40','cursor-not-allowed');
        }

        const t = new Date();
        if(t.getFullYear()===CAL_YEAR && t.getMonth()+1===CAL_MONTH && t.getDate()===d)
          btn.classList.add('ring-1','ring-sjgold/60');

        grid.appendChild(btn);
      }

      const onlyDay = S4_PARSED.every(x => x.month==null || x.month===CAL_MONTH);
      hint.textContent = onlyDay
        ? '提示：表头多为“仅日”，此时月份切换只影响显示，不跨月匹配。'
        : '如需其它月份，点击上方箭头切换后在日历中选择。';
    }

    function selectHeaderRaw(raw){
      SELECTED_HDR_RAW = raw;
      document.getElementById('dateHdrRaw').value = raw;
      renderCalendar();
    }

    function autoPickToday(){
      const t = new Date();
      const raw = (S4_PARSED.find(x => x.month===CAL_MONTH && x.day===t.getDate())
                || S4_PARSED.find(x => x.month==null && x.day===t.getDate()))?.raw;
      if(raw) selectHeaderRaw(raw);
    }

    // ========== 提交 ==========
    async function submitExpense(){
      const carVal  = document.getElementById('carSelect').value;
      const dateHdr = document.getElementById('dateHdrRaw').value;
      const cat     = document.getElementById('catSelect').value;
      const amount  = document.getElementById('amount').value.trim();
      const note    = document.getElementById('note').value.trim();
      const msgEl   = document.getElementById('msg');
      const say = (t) => { msgEl.textContent = t; };

      if(!carVal)  return say('请选择车辆');
      if(!dateHdr) return say('请选择日期');
      if(!cat)     return say('请选择费用类别');
      if(!amount || +amount < 0) return say('请填写有效金额');

      const {stock,year,make,model} = JSON.parse(carVal);
      const dateISO = toISOFromHeader(dateHdr);

      const payload = {
        date: dateISO, dateISO,
        category: cat, expenseKey: cat,
        amount,
        stockId: stock, year, make, model,
        note
      };

      let res, raw;
      try {
        say('提交中…');
        document.getElementById('btnSubmit').disabled = true;

        res = await fetch(`${BACKEND}/sheet4-write`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        raw = await res.text();
        let data;
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok: false, error: `非 JSON 响应：${raw.slice(0,200)}` }; }

        if (!res.ok) return say(`❌ HTTP ${res.status} ${res.statusText} | ${data.error || raw || '未知错误'}`);
        if (data && (data.ok === false || data.success === false)) return say(`❌ 业务错误：${data.error || '未知原因'}`);

        const where = data?.range ? `（写入 ${data.range}）` : '';
        say(`✅ 写入成功 ${where}`);
      } catch (err) {
        say(`❌ 网络异常：${err?.message || err}`);
      } finally {
        document.getElementById('btnSubmit').disabled = false;
      }
    }

    // 表头转年内 ISO
    function toISOFromHeader(hdr){
      const now  = new Date();
      const year = now.getFullYear();
      let m = null, d = null;

      const zh = String(hdr).match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
      if (zh) { m = +zh[1]; d = +zh[2]; }

      if (m === null || d === null) {
        const t  = String(hdr).replace(/\s+/g, '').replace(/[.\-]/g, '/');
        const md = t.match(/(\d{1,2})\/(\d{1,2})/);
        if (md) { m = +md[1]; d = +md[2]; }
        else if (/^\d{1,2}$/.test(t)) { d = +t; m = now.getMonth() + 1; }
      }
      if (!m || !d) { m = now.getMonth() + 1; d = now.getDate(); }

      return `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    // ==================== Cloudinary 多图上传（Home 根目录；中文名） ====================
    // ==================== Cloudinary 多图上传（Home 根目录，支持中文命名） ====================
async function uploadImagesForExpense() {
  const upMsg  = document.getElementById('upMsg');
  const upList = document.getElementById('upList');
  const upPrev = document.getElementById('upPreview');
  const btn    = document.getElementById('btnUploadImgs');

  upMsg.textContent = '';
  upList.innerHTML  = '';
  upPrev.innerHTML  = '';

  // ✅ 强制前置校验
  const carVal  = document.getElementById('carSelect')?.value || '';
  const dateHdr = document.getElementById('dateHdrRaw')?.value || '';
  const catRaw  = document.getElementById('catSelect')?.value || '';
  const amount  = document.getElementById('amount')?.value.trim() || '';

  if (!carVal)  { upMsg.textContent = '❌ 请先选择车辆'; return; }
  if (!dateHdr) { upMsg.textContent = '❌ 请先选择日期'; return; }
  if (!catRaw)  { upMsg.textContent = '❌ 请先选择费用类别'; return; }
  if (!amount || +amount <= 0) { upMsg.textContent = '❌ 请先填写金额'; return; }

  const { stock, year, make, model } = JSON.parse(carVal);
  const files = document.getElementById('imgFiles')?.files;
  if (!files || !files.length) { upMsg.textContent = '❌ 请选择要上传的图片'; return; }

  // 命名：StockID_Year_Make_Model__类别__金额__日期__序号
  const dateISO    = toISOFromHeader(dateHdr); // YYYY-MM-DD
  const prefix     = `${stock}_${year}_${make}_${model}`; // 允许中文/空格，后端已支持
  const catPart    = catRaw;
  const amountPart = amount;
  const datePart   = dateISO;
  const pad2       = (n) => String(n).padStart(2, '0');

  upMsg.textContent = `准备上传 ${files.length} 张...`;

  const results = [];
  try {
    if (btn) btn.disabled = true;

    for (let i = 0; i < files.length; i++) {
      const file     = files[i];
      const indexStr = pad2(i + 1);
      const basename = `${prefix}__${catPart}__${amountPart}__${datePart}__${indexStr}`;

      const row = document.createElement('div');
      row.textContent = `#${indexStr} 正在上传：${file.name}`;
      upList.appendChild(row);

      try {
        // 1) 申请签名（仅 public_id，不传 folder）
        const sigRes = await fetch(`${BACKEND}/get-signature`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ public_id: basename })
        });
        const sigText = await sigRes.text();
        if (!sigRes.ok) throw new Error(`签名失败：${sigText}`);
        const { signature, timestamp, apiKey } = JSON.parse(sigText);

        // 2) 上传到 Cloudinary
        const fd = new FormData();
        fd.append('file', file);
        fd.append('api_key', apiKey);
        fd.append('timestamp', timestamp);
        fd.append('signature', signature);
        fd.append('public_id', basename);
        // 标签/上下文（不参与签名，可以有中文）
        fd.append('tags', ['expense', stock, make, model, catPart].join(','));
        fd.append('context', `alt=${basename}|category=${catRaw}|stock=${stock}|amount=${amount}|date=${dateISO}`);

        const upRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
          method: 'POST',
          body: fd
        });
        const upText = await upRes.text();
        const json = upText ? JSON.parse(upText) : {};
        if (!upRes.ok || !json.secure_url) {
          throw new Error(json?.error?.message || upRes.statusText || '上传失败');
        }

        row.textContent = `#${indexStr} ✅ 成功：${json.public_id}`;
        const img = document.createElement('img');
        img.src = json.secure_url;
        img.alt = json.public_id;
        img.className = 'w-full h-24 object-cover rounded border border-sjgold/20';
        upPrev.appendChild(img);

        results.push(json);
      } catch (err) {
        row.textContent = `#${indexStr} ❌ 失败：${err.message}`;
      }
    }
  } finally {
    if (btn) btn.disabled = false;
  }

  upMsg.textContent = results.length
    ? `完成：成功 ${results.length} / 共 ${files.length}`
    : '全部失败，请重试或检查控制台日志。';
}
  </script>
</body>
</html>
