<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto · 费用录入</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ sjgold:'#FFD700' } } } }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">费用录入（Sheet4 ⇢ 按日期列）</h1>
      <a href="query.html" class="text-sm opacity-75 hover:opacity-100">查询</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">

      <!-- 1. 选择车辆（来自 Sheet5 前四列，合并展示） -->
      <div>
        <label class="block text-sm mb-1">选择车辆（来自 Sheet5）<span class="text-sjgold">*</span></label>
        <select id="carSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"></select>
        <p class="mt-1 text-xs opacity-70">展示为：StockID · Year Make Model</p>
      </div>

      <!-- 2. 选择日期（来自 Sheet4 的第一行）→ 月历网格 -->
      <div>
        <label class="block text-sm mb-2">日期（来自 Sheet4 表头）<span class="text-sjgold">*</span></label>

        <!-- 月份切换 -->
        <div class="flex items-center justify-between mb-2">
          <button id="calPrev" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">←</button>
          <div id="calTitle" class="text-sm font-semibold"></div>
          <button id="calNext" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">→</button>
        </div>

        <!-- 周标题 -->
        <div class="grid grid-cols-7 text-xs opacity-70 mb-1">
          <div class="text-center py-1">Mon</div>
          <div class="text-center py-1">Tue</div>
          <div class="text-center py-1">Wed</div>
          <div class="text-center py-1">Thu</div>
          <div class="text-center py-1">Fri</div>
          <div class="text-center py-1">Sat</div>
          <div class="text-center py-1">Sun</div>
        </div>

        <!-- 日历网格 -->
        <div id="calGrid" class="grid grid-cols-7 gap-1"></div>

        <!-- 保存选中的“表头原文”，提交用 -->
        <input id="dateHdrRaw" type="hidden" />
        <p class="mt-2 text-xs opacity-70" id="calHint"></p>
      </div>

      <!-- 3. 费用类别（11 个选项——使用你给的原文） -->
      <div>
        <label class="block text-sm mb-1">费用类别<span class="text-sjgold">*</span></label>
        <select id="catSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="税前买入金额">税前买入金额</option>
          <option value="买断金额（lease）">买断金额（lease）</option>
          <option value="车主证过户费用">车主证过户费用</option>
          <option value="转lease费用/买断费用">转lease费用/买断费用</option>
          <option value="检修费用">检修费用</option>
          <option value="加油费用">加油费用</option>
          <option value="上牌费用">上牌费用</option>
          <option value="银行手续费">银行手续费</option>
          <option value="客户返佣">客户返佣</option>
          <option value="中介返佣">中介返佣</option>
          <option value="员工激励">员工激励</option>
        </select>
      </div>

      <!-- 4. 金额 -->
      <div>
        <label class="block text-sm mb-1">金额（CAD）<span class="text-sjgold">*</span></label>
        <input id="amount" type="number" step="0.01" min="0"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="例如 2800"/>
      </div>

      <!-- 备注（可选） -->
      <div>
        <label class="block text-sm mb-1">备注（可选）</label>
        <input id="note" type="text"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="如：贴膜 / 拖车费 …"/>
      </div>
<!-- 5. 上传图片（可选，多选） -->
<div class="space-y-2">
  <label class="block text-sm">上传图片（可多选）</label>
  <input id="imgFiles" type="file" accept="image/*" multiple
         class="block w-full text-sm file:mr-3 file:px-4 file:py-2 file:rounded-lg file:border-0 file:bg-sjgold file:text-black hover:file:brightness-95"/>
  <div class="flex items-center gap-2">
    <button type="button" id="btnUploadImgs"
            class="inline-flex items-center justify-center gap-2 px-4 h-10 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900">
      上传到 Cloudinary
    </button>
    <span id="upMsg" class="text-xs opacity-80"></span>
  </div>
  <div id="upList" class="space-y-2 text-xs"></div>
  <div id="upPreview" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
</div>
      <!-- 提交 -->
      <div class="pt-2">
        <button id="btnSubmit"
                class="inline-flex items-center justify-center gap-2 px-6 h-11 rounded-xl bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90">
          提交 
        </button>
        <span id="msg" class="ml-3 text-sm opacity-80"></span>
      </div>
    </section>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';

    // --------- 工具：表头规范化 & 下标查找（容错大小写/空格/下划线） ----------
    const normalize = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const getCol = (headers, candidates) => {
      const map = headers.map(h => normalize(h));
      for (const c of candidates) {
        const i = map.indexOf(normalize(c));
        if (i !== -1) return i;
      }
      return -1;
    };

    // ========== 初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadCarsFromSheet5();
      loadDatesFromSheet4();
      document.getElementById('btnSubmit').addEventListener('click', submitExpense);
      document.getElementById('calPrev').addEventListener('click', ()=>{ CAL_MONTH--; if(CAL_MONTH===0){CAL_MONTH=12;CAL_YEAR--;} renderCalendar(); });
      document.getElementById('calNext').addEventListener('click', ()=>{ CAL_MONTH++; if(CAL_MONTH===13){CAL_MONTH=1;CAL_YEAR++;} renderCalendar(); });
    });

    // 1) 读 Sheet5 前四列→组合显示
    async function loadCarsFromSheet5(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet5 为空');
        const [header, ...rows] = values;

        // 兼容 StockID / Stockid / stock id 等
        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelect');
        sel.innerHTML = '';

        rows.forEach(row => {
          const stock = row[stockIdx] || '';
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          if(!stock) return;
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model});
          opt.textContent = `${stock} · ${year} ${make} ${model}`.trim();
          sel.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        document.getElementById('carSelect').innerHTML = '<option>加载失败</option>';
      }
    }

    // ========== 月历相关 ==========
    let S4_HEADERS_RAW = [];   // 第一行（除首列）原文
    let S4_PARSED = [];        // [{raw, month, day}]
    let CAL_YEAR, CAL_MONTH;   // 当前显示的年月
    let SELECTED_HDR_RAW = ''; // 选中的表头原文

    function parseHeaderMD(h){
      const s = String(h||'').trim();
      let m = s.match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/); // 9月1日
      if(m) return { month:+m[1], day:+m[2] };
      const t = s.replace(/[.\-]/g,'/');
      m = t.match(/(\d{1,2})\/(\d{1,2})/);               // 9/1、09-01
      if(m) return { month:+m[1], day:+m[2] };
      if(/^\d{1,2}$/.test(s)) return { month:null, day:+s }; // 仅“日”
      return { month:null, day:null };
    }

    async function loadDatesFromSheet4(){
      try{
        const r = await fetch(`${BACKEND}/sheet4`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet4 为空');
        const header = values[0] || [];

        S4_HEADERS_RAW = header.slice(1).map(v => String(v||'').trim());
        S4_PARSED = S4_HEADERS_RAW.map(raw => ({ raw, ...parseHeaderMD(raw) }));

        const today = new Date();
        CAL_YEAR = today.getFullYear();

        const months = S4_PARSED.map(x=>x.month).filter(m=>m!=null);
        if (months.length === 0) {
          // 表头全是“仅日”，直接用当前月
          CAL_MONTH = today.getMonth() + 1;
        } else {
          CAL_MONTH = months.includes(today.getMonth()+1)
            ? (today.getMonth()+1)
            : months[0];
        }

        renderCalendar();
        autoPickToday();
      }catch(e){
        console.error(e);
        document.getElementById('calGrid').innerHTML =
          '<div class="col-span-7 text-center py-6 opacity-70">日期加载失败</div>';
      }
    }

    function renderCalendar(){
      const grid  = document.getElementById('calGrid');
      const title = document.getElementById('calTitle');
      const hint  = document.getElementById('calHint');

      // 兜底
      if (!CAL_YEAR || !CAL_MONTH) {
        const t = new Date();
        CAL_YEAR  = CAL_YEAR  || t.getFullYear();
        CAL_MONTH = CAL_MONTH || (t.getMonth() + 1);
      }

      title.textContent = `${CAL_YEAR}-${String(CAL_MONTH).padStart(2,'0')}`;

      const first = new Date(CAL_YEAR, CAL_MONTH-1, 1);
      const startCol = (first.getDay()+6)%7; // 周一=0 … 周日=6
      const days = new Date(CAL_YEAR, CAL_MONTH, 0).getDate();

      grid.innerHTML = '';
      for(let i=0;i<startCol;i++) grid.appendChild(document.createElement('div'));

      for(let d=1; d<=days; d++){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='relative w-full aspect-square rounded-lg border border-sjgold/20 hover:border-sjgold/50 text-sm';

        const match = S4_PARSED.find(x => x.month===CAL_MONTH && x.day===d)
                   || S4_PARSED.find(x => x.month==null && x.day===d);
        btn.textContent = d;
        if(match){
          btn.onclick = ()=>selectHeaderRaw(match.raw);
          if(SELECTED_HDR_RAW && match.raw===SELECTED_HDR_RAW)
            btn.classList.add('bg-sjgold','text-black','font-semibold');
        }else{
          btn.classList.add('opacity-40','cursor-not-allowed');
        }

        const t = new Date();
        if(t.getFullYear()===CAL_YEAR && t.getMonth()+1===CAL_MONTH && t.getDate()===d)
          btn.classList.add('ring-1','ring-sjgold/60');

        grid.appendChild(btn);
      }

      const onlyDay = S4_PARSED.every(x => x.month==null || x.month===CAL_MONTH);
      hint.textContent = onlyDay
        ? '提示：表头多为“仅日”，此时月份切换只影响显示，不跨月匹配。'
        : '如需其它月份，点击上方箭头切换后在日历中选择。';
    }

    function selectHeaderRaw(raw){
      SELECTED_HDR_RAW = raw;
      document.getElementById('dateHdrRaw').value = raw;
      renderCalendar();
    }

    function autoPickToday(){
      const t = new Date();
      const raw = (S4_PARSED.find(x => x.month===CAL_MONTH && x.day===t.getDate())
                || S4_PARSED.find(x => x.month==null && x.day===t.getDate()))?.raw;
      if(raw) selectHeaderRaw(raw);
    }
// ========== 提交 ==========
async function submitExpense(){
  const carVal  = document.getElementById('carSelect').value;
  const dateHdr = document.getElementById('dateHdrRaw').value;
  const cat     = document.getElementById('catSelect').value;
  const amount  = document.getElementById('amount').value.trim();
  const note    = document.getElementById('note').value.trim();
  const msgEl   = document.getElementById('msg');

  const say = (t) => { msgEl.textContent = t; };

  if(!carVal)  return say('请选择车辆');
  if(!dateHdr) return say('请选择日期');
  if(!cat)     return say('请选择费用类别');
  if(!amount || +amount < 0) return say('请填写有效金额');

  const {stock,year,make,model} = JSON.parse(carVal);
  const dateISO = toISOFromHeader(dateHdr);

  const payload = {
    // 同时带上两套键名，兼容你后端的两种写法（date/dateISO、category/expenseKey）
    date: dateISO,
    dateISO,
    category: cat,
    expenseKey: cat,
    amount,
    stockId: stock,
    year, make, model,
    note
  };

  let res, raw;
  try {
    say('提交中…');
    document.getElementById('btnSubmit').disabled = true;

    res = await fetch(`${BACKEND}/sheet4-write`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // 先取原始文本，方便在 JSON 解析失败时也能看到报错内容
    raw = await res.text();

    // 尝试解析 JSON（可能是 { ok:false, error:"..." }）
    let data;
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok: false, error: `非 JSON 响应：${raw.slice(0,200)}` }; }

    // HTTP 非 2xx
    if (!res.ok) {
      return say(`❌ HTTP ${res.status} ${res.statusText} | ${data.error || raw || '未知错误'}`);
    }

    // HTTP 2xx，但业务失败
    if (data && (data.ok === false || data.success === false)) {
      return say(`❌ 业务错误：${data.error || '未知原因'}`);
    }

    // 成功
    const where = data?.range ? `（写入 ${data.range}）` : '';
    say(`✅ 写入成功 ${where}`);
  } catch (err) {
    // 网络层异常
    say(`❌ 网络异常：${err?.message || err}`);
  } finally {
    document.getElementById('btnSubmit').disabled = false;
  }
}

// 将表头“9/1、09-01、9.1、9月1日、1”等 => 本年 ISO（YYYY-MM-DD）
function toISOFromHeader(hdr){
  const now  = new Date();
  const year = now.getFullYear();
  let m = null, d = null;

  // 9月1日
  const zh = String(hdr).match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
  if (zh) { m = +zh[1]; d = +zh[2]; }

  if (m === null || d === null) {
    // 9/1、09-01、9.1
    const t  = String(hdr).replace(/\s+/g, '').replace(/[.\-]/g, '/');
    const md = t.match(/(\d{1,2})\/(\d{1,2})/);
    if (md) { m = +md[1]; d = +md[2]; }
    // 仅“日”（如：1, 31）=> 用当月
    else if (/^\d{1,2}$/.test(t)) { d = +t; m = now.getMonth() + 1; }
  }

  // 仍解析失败则用今天
  if (!m || !d) { m = now.getMonth() + 1; d = now.getDate(); }

  const mm = String(m).padStart(2, '0');
  const dd = String(d).padStart(2, '0');
  return `${year}-${mm}-${dd}`;
}
  </script>
</body>
</html>
