<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto Â· è´¹ç”¨å½•å…¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ sjgold:'#FFD700' } } } }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold">
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold">è´¹ç”¨å½•å…¥ï¼ˆSheet4 â‡¢ æŒ‰æ—¥æœŸåˆ—ï¼‰</h1>
      <a href="query.html" class="text-sm opacity-75 hover:opacity-100">æŸ¥è¯¢</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6 space-y-6">
    <section class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">

      <!-- 1) é€‰æ‹©è½¦è¾†ï¼ˆSheet5ï¼‰ -->
      <div>
        <label class="block text-sm mb-1">é€‰æ‹©è½¦è¾†ï¼ˆæ¥è‡ª Sheet5ï¼‰<span class="text-sjgold">*</span></label>
        <select id="carSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"></select>
        <p class="mt-1 text-xs opacity-70">å±•ç¤ºä¸ºï¼šStockID Â· Year Make Model</p>
      </div>

      <!-- 2) é€‰æ‹©æ—¥æœŸï¼ˆè¡¨å¤´ï¼‰â†’ æœˆå†ç½‘æ ¼ -->
      <div>
        <label class="block text-sm mb-2">æ—¥æœŸï¼ˆæ¥è‡ª Sheet4 è¡¨å¤´ï¼‰<span class="text-sjgold">*</span></label>

        <div class="flex items-center justify-between mb-2">
          <button id="calPrev" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">â†</button>
          <div id="calTitle" class="text-sm font-semibold"></div>
          <button id="calNext" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">â†’</button>
        </div>

        <div class="grid grid-cols-7 text-xs opacity-70 mb-1">
          <div class="text-center py-1">Mon</div><div class="text-center py-1">Tue</div><div class="text-center py-1">Wed</div>
          <div class="text-center py-1">Thu</div><div class="text-center py-1">Fri</div><div class="text-center py-1">Sat</div><div class="text-center py-1">Sun</div>
        </div>

        <div id="calGrid" class="grid grid-cols-7 gap-1"></div>
        <input id="dateHdrRaw" type="hidden" />
        <p class="mt-2 text-xs opacity-70" id="calHint"></p>
      </div>

      <!-- 3) è´¹ç”¨ç±»åˆ« -->
      <div>
        <label class="block text-sm mb-1">è´¹ç”¨ç±»åˆ«<span class="text-sjgold">*</span></label>
        <select id="catSelect" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500">
          <option value="ç¨å‰ä¹°å…¥é‡‘é¢">ç¨å‰ä¹°å…¥é‡‘é¢</option>
          <option value="ä¹°æ–­é‡‘é¢ï¼ˆleaseï¼‰">ä¹°æ–­é‡‘é¢ï¼ˆleaseï¼‰</option>
          <option value="è½¦ä¸»è¯è¿‡æˆ·è´¹ç”¨">è½¦ä¸»è¯è¿‡æˆ·è´¹ç”¨</option>
          <option value="è½¬leaseè´¹ç”¨/ä¹°æ–­è´¹ç”¨">è½¬leaseè´¹ç”¨/ä¹°æ–­è´¹ç”¨</option>
          <option value="æ£€ä¿®è´¹ç”¨">æ£€ä¿®è´¹ç”¨</option>
          <option value="åŠ æ²¹è´¹ç”¨">åŠ æ²¹è´¹ç”¨</option>
          <option value="ä¸Šç‰Œè´¹ç”¨">ä¸Šç‰Œè´¹ç”¨</option>
          <option value="é“¶è¡Œæ‰‹ç»­è´¹">é“¶è¡Œæ‰‹ç»­è´¹</option>
          <option value="å®¢æˆ·è¿”ä½£">å®¢æˆ·è¿”ä½£</option>
          <option value="ä¸­ä»‹è¿”ä½£">ä¸­ä»‹è¿”ä½£</option>
          <option value="å‘˜å·¥æ¿€åŠ±">å‘˜å·¥æ¿€åŠ±</option>
        </select>
      </div>

      <!-- 4) é‡‘é¢ -->
      <div>
        <label class="block text-sm mb-1">é‡‘é¢ï¼ˆCADï¼‰<span class="text-sjgold">*</span></label>
        <input id="amount" type="number" step="0.01" min="0"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="ä¾‹å¦‚ 2800"/>
      </div>

      <!-- å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ -->
      <div>
        <label class="block text-sm mb-1">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="note" type="text"
               class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500"
               placeholder="å¦‚ï¼šè´´è†œ / æ‹–è½¦è´¹ â€¦"/>
      </div>

      <!-- 5) ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œå¤šé€‰ï¼‰ -->
      <div class="space-y-2">
        <label class="block text-sm">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</label>
        <input id="imgFiles" type="file" accept="image/*" multiple
               class="block w-full text-sm file:mr-3 file:px-4 file:py-2 file:rounded-lg file:border-0 file:bg-sjgold file:text-black hover:file:brightness-95"/>
        <div class="flex items-center gap-2">
          <button type="button" id="btnUploadImgs"
                  class="inline-flex items-center justify-center gap-2 px-4 h-10 rounded-xl border border-sjgold/40 text-sjgold hover:bg-zinc-900">
            ä¸Šä¼ åˆ° Cloudinary
          </button>
          <span id="upMsg" class="text-xs opacity-80"></span>
        </div>
        <div id="upList" class="space-y-2 text-xs"></div>
        <div id="upPreview" class="grid grid-cols-3 sm:grid-cols-4 gap-2"></div>
      </div>

      <!-- æäº¤ -->
      <div class="pt-2">
        <button id="btnSubmit"
                class="inline-flex items-center justify-center gap-2 px-6 h-11 rounded-xl bg-sjgold text-black font-semibold hover:brightness-95 active:brightness-90">
          æäº¤
        </button>
        <span id="msg" class="ml-3 text-sm opacity-80"></span>
      </div>
    </section>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg'; // ä¸åç«¯ env ä¸€è‡´

    // ---------- å°å·¥å…· ----------
    const normalize = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const getCol = (headers, candidates) => {
      const map = headers.map(h => normalize(h));
      for (const c of candidates) {
        const i = map.indexOf(normalize(c));
        if (i !== -1) return i;
      }
      return -1;
    };
    const toSlug = (s) => {
      if (!s) return '';
      let t = String(s).trim();
      t = t.normalize('NFKD')
           .replace(/[\u0300-\u036f]/g, '')
           .replace(/\s+/g, '-')
           .replace(/[&:ï¼šã€ï¼Œ,.;ã€‚\/\\]+/g, '-')
           .toLowerCase();
      t = t.replace(/[^a-z0-9\u4e00-\u9fa5_-]/g, '-')
           .replace(/-+/g, '-')
           .replace(/(^-|-$)/g, '');
      return t || 'x';
    };
    const safeFolder = ({stock, year, make, model}) =>
      [stock, year, make, model].map(toSlug).join('_');
    const pad2 = (n) => String(n).padStart(2, '0');

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadCarsFromSheet5();
      loadDatesFromSheet4();
      document.getElementById('btnSubmit').addEventListener('click', submitExpense);
      document.getElementById('calPrev').addEventListener('click', ()=>{ CAL_MONTH--; if(CAL_MONTH===0){CAL_MONTH=12;CAL_YEAR--;} renderCalendar(); });
      document.getElementById('calNext').addEventListener('click', ()=>{ CAL_MONTH++; if(CAL_MONTH===13){CAL_MONTH=1;CAL_YEAR++;} renderCalendar(); });
      document.getElementById('btnUploadImgs').addEventListener('click', uploadImagesForExpense);
    });

    // 1) è¯» Sheet5 å‰å››åˆ—â†’ç»„åˆæ˜¾ç¤º
    async function loadCarsFromSheet5(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet5 ä¸ºç©º');
        const [header, ...rows] = values;

        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelect');
        sel.innerHTML = '';

        rows.forEach(row => {
          const stock = row[stockIdx] || '';
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          if(!stock) return;
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model});
          opt.textContent = `${stock} Â· ${year} ${make} ${model}`.trim();
          sel.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        document.getElementById('carSelect').innerHTML = '<option>åŠ è½½å¤±è´¥</option>';
      }
    }

    // ========== æœˆå†ç›¸å…³ ==========
    let S4_HEADERS_RAW = [];
    let S4_PARSED = [];
    let CAL_YEAR, CAL_MONTH;
    let SELECTED_HDR_RAW = '';

    function parseHeaderMD(h){
      const s = String(h||'').trim();
      let m = s.match(/(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
      if(m) return { month:+m[1], day:+m[2] };
      const t = s.replace(/[.\-]/g,'/');
      m = t.match(/(\d{1,2})\/(\d{1,2})/);
      if(m) return { month:+m[1], day:+m[2] };
      if(/^\d{1,2}$/.test(s)) return { month:null, day:+s };
      return { month:null, day:null };
    }

    async function loadDatesFromSheet4(){
      try{
        const r = await fetch(`${BACKEND}/sheet4`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet4 ä¸ºç©º');
        const header = values[0] || [];

        S4_HEADERS_RAW = header.slice(1).map(v => String(v||'').trim());
        S4_PARSED = S4_HEADERS_RAW.map(raw => ({ raw, ...parseHeaderMD(raw) }));

        const today = new Date();
        CAL_YEAR = today.getFullYear();

        const months = S4_PARSED.map(x=>x.month).filter(m=>m!=null);
        CAL_MONTH = months.length === 0 ? (today.getMonth()+1)
                  : (months.includes(today.getMonth()+1) ? (today.getMonth()+1) : months[0]);

        renderCalendar();
        autoPickToday();
      }catch(e){
        console.error(e);
        document.getElementById('calGrid').innerHTML =
          '<div class="col-span-7 text-center py-6 opacity-70">æ—¥æœŸåŠ è½½å¤±è´¥</div>';
      }
    }

    function renderCalendar(){
      const grid  = document.getElementById('calGrid');
      const title = document.getElementById('calTitle');
      const hint  = document.getElementById('calHint');

      if (!CAL_YEAR || !CAL_MONTH) {
        const t = new Date();
        CAL_YEAR  = CAL_YEAR  || t.getFullYear();
        CAL_MONTH = CAL_MONTH || (t.getMonth() + 1);
      }
      title.textContent = `${CAL_YEAR}-${String(CAL_MONTH).padStart(2,'0')}`;

      const first = new Date(CAL_YEAR, CAL_MONTH-1, 1);
      const startCol = (first.getDay()+6)%7;
      const days = new Date(CAL_YEAR, CAL_MONTH, 0).getDate();

      grid.innerHTML = '';
      for(let i=0;i<startCol;i++) grid.appendChild(document.createElement('div'));

      for(let d=1; d<=days; d++){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='relative w-full aspect-square rounded-lg border border-sjgold/20 hover:border-sjgold/50 text-sm';

        const match = S4_PARSED.find(x => x.month===CAL_MONTH && x.day===d)
                   || S4_PARSED.find(x => x.month==null && x.day===d);
        btn.textContent = d;
        if(match){
          btn.onclick = ()=>selectHeaderRaw(match.raw);
          if(SELECTED_HDR_RAW && match.raw===SELECTED_HDR_RAW)
            btn.classList.add('bg-sjgold','text-black','font-semibold');
        }else{
          btn.classList.add('opacity-40','cursor-not-allowed');
        }

        const t = new Date();
        if(t.getFullYear()===CAL_YEAR && t.getMonth()+1===CAL_MONTH && t.getDate()===d)
          btn.classList.add('ring-1','ring-sjgold/60');

        grid.appendChild(btn);
      }

      const onlyDay = S4_PARSED.every(x => x.month==null || x.month===CAL_MONTH);
      hint.textContent = onlyDay
        ? 'æç¤ºï¼šè¡¨å¤´å¤šä¸ºâ€œä»…æ—¥â€ï¼Œæ­¤æ—¶æœˆä»½åˆ‡æ¢åªå½±å“æ˜¾ç¤ºï¼Œä¸è·¨æœˆåŒ¹é…ã€‚'
        : 'å¦‚éœ€å…¶å®ƒæœˆä»½ï¼Œç‚¹å‡»ä¸Šæ–¹ç®­å¤´åˆ‡æ¢ååœ¨æ—¥å†ä¸­é€‰æ‹©ã€‚';
    }

    function selectHeaderRaw(raw){
      SELECTED_HDR_RAW = raw;
      document.getElementById('dateHdrRaw').value = raw;
      renderCalendar();
    }

    function autoPickToday(){
      const t = new Date();
      const raw = (S4_PARSED.find(x => x.month===CAL_MONTH && x.day===t.getDate())
                || S4_PARSED.find(x => x.month==null && x.day===t.getDate()))?.raw;
      if(raw) selectHeaderRaw(raw);
    }

    // ========== æäº¤ ==========
    async function submitExpense(){
      const carVal  = document.getElementById('carSelect').value;
      const dateHdr = document.getElementById('dateHdrRaw').value;
      const cat     = document.getElementById('catSelect').value;
      const amount  = document.getElementById('amount').value.trim();
      const note    = document.getElementById('note').value.trim();
      const msgEl   = document.getElementById('msg');
      const say = (t) => { msgEl.textContent = t; };

      if(!carVal)  return say('è¯·é€‰æ‹©è½¦è¾†');
      if(!dateHdr) return say('è¯·é€‰æ‹©æ—¥æœŸ');
      if(!cat)     return say('è¯·é€‰æ‹©è´¹ç”¨ç±»åˆ«');
      if(!amount || +amount < 0) return say('è¯·å¡«å†™æœ‰æ•ˆé‡‘é¢');

      const {stock,year,make,model} = JSON.parse(carVal);
      const dateISO = toISOFromHeader(dateHdr);

      const payload = {
        date: dateISO, dateISO,
        category: cat, expenseKey: cat,
        amount,
        stockId: stock, year, make, model,
        note
      };

      let res, raw;
      try {
        say('æäº¤ä¸­â€¦');
        document.getElementById('btnSubmit').disabled = true;

        res = await fetch(`${BACKEND}/sheet4-write`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        raw = await res.text();
        let data;
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = { ok: false, error: `é JSON å“åº”ï¼š${raw.slice(0,200)}` }; }

        if (!res.ok) return say(`âŒ HTTP ${res.status} ${res.statusText} | ${data.error || raw || 'æœªçŸ¥é”™è¯¯'}`);
        if (data && (data.ok === false || data.success === false)) return say(`âŒ ä¸šåŠ¡é”™è¯¯ï¼š${data.error || 'æœªçŸ¥åŸå› '}`);

        const where = data?.range ? `ï¼ˆå†™å…¥ ${data.range}ï¼‰` : '';
        say(`âœ… å†™å…¥æˆåŠŸ ${where}`);
      } catch (err) {
        say(`âŒ ç½‘ç»œå¼‚å¸¸ï¼š${err?.message || err}`);
      } finally {
        document.getElementById('btnSubmit').disabled = false;
      }
    }

    // è¡¨å¤´è½¬å¹´å†… ISO
    function toISOFromHeader(hdr){
      const now  = new Date();
      const year = now.getFullYear();
      let m = null, d = null;

      const zh = String(hdr).match(/(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
      if (zh) { m = +zh[1]; d = +zh[2]; }

      if (m === null || d === null) {
        const t  = String(hdr).replace(/\s+/g, '').replace(/[.\-]/g, '/');
        const md = t.match(/(\d{1,2})\/(\d{1,2})/);
        if (md) { m = +md[1]; d = +md[2]; }
        else if (/^\d{1,2}$/.test(t)) { d = +t; m = now.getMonth() + 1; }
      }
      if (!m || !d) { m = now.getMonth() + 1; d = now.getDate(); }

      return `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    // ==================== Cloudinary å¤šå›¾ä¸Šä¼ ï¼ˆfolder + basename public_idï¼‰ ====================
    async function uploadImagesForExpense(){
     const upMsg  = document.getElementById('upMsg');
  const upList = document.getElementById('upList');
  const upPrev = document.getElementById('upPreview');
  upMsg.textContent = '';
  upList.innerHTML  = '';
  upPrev.innerHTML  = '';

  // ğŸš¨ å¼ºåˆ¶æ ¡éªŒ
  const carVal = document.getElementById('carSelect')?.value || '';
  const dateHdr = document.getElementById('dateHdrRaw')?.value || '';
  const catRaw = document.getElementById('catSelect')?.value || '';
  const amount = document.getElementById('amount')?.value.trim() || '';

  if (!carVal) { upMsg.textContent = 'âŒ è¯·å…ˆé€‰æ‹©è½¦è¾†'; return; }
  if (!dateHdr) { upMsg.textContent = 'âŒ è¯·å…ˆé€‰æ‹©æ—¥æœŸ'; return; }
  if (!catRaw) { upMsg.textContent = 'âŒ è¯·å…ˆé€‰æ‹©è´¹ç”¨ç±»åˆ«'; return; }
  if (!amount || +amount <= 0) { upMsg.textContent = 'âŒ è¯·å…ˆå¡«å†™é‡‘é¢'; return; }

  const {stock, year, make, model} = JSON.parse(carVal);
  const files = document.getElementById('imgFiles')?.files;
  if (!files || !files.length) { upMsg.textContent = 'âŒ è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡'; return; }

  // å‘½åé€»è¾‘
  const folder   = safeFolder({stock, year, make, model});
  const prefix   = `${toSlug(stock)}_${toSlug(year)}_${toSlug(make)}_${toSlug(model)}`;
  const catSlug  = toSlug(catRaw);

  upMsg.textContent = `å‡†å¤‡ä¸Šä¼  ${files.length} å¼ ...`;

      btn.disabled = true;

      const results = [];

      for (let i = 0; i < files.length; i++) {
        const file     = files[i];
        const indexStr = pad2(i+1); // 01ã€02...
        const basename = `${prefix}__${catSlug}__${indexStr}`; // ä¸å¸¦æ–œæ çš„ public_id
        const row = document.createElement('div');
        row.textContent = `#${indexStr} æ­£åœ¨ä¸Šä¼ ï¼š${file.name}`;
        upList.appendChild(row);

        try {
          // 1) å…ˆå‘åç«¯è¦ç­¾åï¼ˆåç«¯ä¼šç”¨ folder+basename ç»„åˆæˆ fullPublicId ç­¾åï¼‰
          const sigRes = await fetch(`${BACKEND}/get-signature`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ public_id: basename, folder })
          });
          if (!sigRes.ok) {
            const t = await sigRes.text();
            throw new Error(`ç­¾åå¤±è´¥ï¼š${t}`);
          }
          const { signature, timestamp, apiKey } = await sigRes.json();

          // 2) ä¸Šä¼ åˆ° Cloudinaryï¼ˆæ˜¾å¼ä¼  folder ä¸ basename public_idï¼‰
          const fd = new FormData();
          fd.append('file', file);
          fd.append('api_key', apiKey);
          fd.append('timestamp', timestamp);
          fd.append('signature', signature);
          fd.append('public_id', basename); // åªæ”¾ basename
          fd.append('folder', folder);      // æ”¾åˆ°å¯¹åº”æ–‡ä»¶å¤¹
          // å¯é€‰ï¼šæ ‡ç­¾ä¸ä¸Šä¸‹æ–‡ï¼Œæ–¹ä¾¿æ£€ç´¢
          fd.append('tags', [ 'expense', toSlug(stock), toSlug(make), toSlug(model), catSlug ].join(','));
          fd.append('context', `alt=${basename}|category=${categoryRaw}|stock=${stock}`);

          const upRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: fd
          });
          const json = await upRes.json();
          if (!upRes.ok || !json.secure_url) {
            throw new Error(json.error?.message || 'ä¸Šä¼ å¤±è´¥');
          }

          row.textContent = `#${indexStr} âœ… æˆåŠŸï¼š${json.public_id}`;
          const img = document.createElement('img');
          img.src = json.secure_url;
          img.alt = json.public_id;
          img.className = 'w-full h-24 object-cover rounded border border-sjgold/20';
          upPrev.appendChild(img);

          results.push(json);
        } catch (e) {
          row.textContent = `#${indexStr} âŒ å¤±è´¥ï¼š${e.message}`;
        }
      }

      btn.disabled = false;
      if (results.length) {
        upMsg.textContent = `å®Œæˆï¼šæˆåŠŸ ${results.length} / å…± ${files.length}`;
      } else {
        upMsg.textContent = 'å…¨éƒ¨å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚';
      }
    }
  </script>
</body>
</html>
