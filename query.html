<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto Â· æŸ¥è¯¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{ extend:{
        colors:{ sjgold:'#FFD700' },
        boxShadow:{ soft:'0 6px 24px rgba(255,215,0,0.08), 0 2px 8px rgba(0,0,0,0.25)' }
      } }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold/90 antialiased">
  <!-- é¡¶éƒ¨ -->
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-sjgold/10 ring-1 ring-sjgold/20">ğŸ“Š</span>
        <h1 class="text-lg sm:text-xl font-semibold tracking-wide">æŸ¥è¯¢ Â· è´¹ç”¨ & ç…§ç‰‡</h1>
      </div>
      <nav class="text-sm flex gap-3">
        <a href="index.html" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">å½•å…¥</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="flex gap-3">
      <button id="tabByDate" class="px-4 h-10 rounded-xl border border-sjgold/30 bg-sjgold text-black font-medium shadow-soft">æŒ‰æ—¥æœŸ</button>
      <button id="tabByCar"  class="px-4 h-10 rounded-xl border border-sjgold/30 hover:bg-zinc-900">æŒ‰è½¦å‹</button>
    </div>

    <!-- ================= æŒ‰æ—¥æœŸ ================= -->
    <section id="panelDate" class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="flex items-end flex-wrap gap-3">
        <div>
          <label class="block text-sm opacity-80">é€‰æ‹©æ—¥æœŸ</label>
          <input id="dateHdrRawA" type="date"
                 class="mt-1 bg-black/60 border border-sjgold/30 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-yellow-500"/>
        </div>
        <div>
          <label class="block text-sm opacity-80">è´¹ç”¨ç±»åˆ«ï¼ˆå¯é€‰ï¼‰</label>
          <select id="catFilterA" class="mt-1 rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 text-sm outline-none">
            <option value="">ï¼ˆå…¨éƒ¨ï¼‰</option>
            <option>ç¨å‰ä¹°å…¥é‡‘é¢</option>
            <option>ä¹°æ–­é‡‘é¢ï¼ˆleaseï¼‰</option>
            <option>è½¦ä¸»è¯è¿‡æˆ·è´¹ç”¨</option>
            <option>è½¬leaseè´¹ç”¨/ä¹°æ–­è´¹ç”¨</option>
            <option>æ£€ä¿®è´¹ç”¨</option>
            <option>åŠ æ²¹è´¹ç”¨</option>
            <option>ä¸Šç‰Œè´¹ç”¨</option>
            <option>é“¶è¡Œæ‰‹ç»­è´¹</option>
            <option>å®¢æˆ·è¿”ä½£</option>
            <option>ä¸­ä»‹è¿”ä½£</option>
            <option>å‘˜å·¥æ¿€åŠ±</option>
          </select>
        </div>
        <button id="btnLoadA"
                class="ml-auto px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">
          åŠ è½½
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <h2 class="text-sm mb-2 opacity-80">è®°å½•</h2>
          <div id="listA" class="space-y-2"></div>
        </div>
        <div>
          <h2 class="text-sm mb-2 opacity-80">å›¾ç‰‡</h2>
          <div id="picsA" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
      <div id="msgA" class="text-xs opacity-75"></div>
    </section>

    <!-- ================= æŒ‰è½¦å‹ ================= -->
    <section id="panelCar" class="hidden bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="flex items-end gap-3">
        <div class="flex-1">
          <label class="block text-sm opacity-80">é€‰æ‹©è½¦å‹ï¼ˆæ¥è‡ª Sheet5ï¼‰</label>
          <select id="carSelectB" class="mt-1 w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 text-sm outline-none"></select>
        </div>
        <button id="btnLoadB"
                class="px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">
          åŠ è½½
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <h2 class="text-sm mb-2 opacity-80">è¯¥è½¦è´¹ç”¨è®°å½•</h2>
          <div id="listB" class="space-y-2"></div>
        </div>
        <div>
          <h2 class="text-sm mb-2 opacity-80">è¯¥è½¦æ‰€æœ‰ç…§ç‰‡</h2>
          <div id="picsB" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
      <div id="msgB" class="text-xs opacity-75"></div>
    </section>
  </main>

  <script>
    /* ============ é…ç½® ============ */
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    /* ============ å·¥å…·å‡½æ•° ============ */
    const toSlug = (s) => {
      if (!s) return '';
      let t = String(s).trim();
      t = t.normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
           .replace(/\s+/g, '-').replace(/[&:ï¼šã€ï¼Œ,.;ã€‚\/\\]+/g, '-')
           .toLowerCase();
      t = t.replace(/[^a-z0-9\u4e00-\u9fa5_-]/g, '-').replace(/-+/g, '-').replace(/(^-|-$)/g, '');
      return t || 'x';
    };
    const pad2 = n => String(n).padStart(2,'0');
    const getCol = (headers, candidates) => {
      const n = (s)=>String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
      const map = headers.map(h=>n(h));
      for (const c of candidates) { const i = map.indexOf(n(c)); if (i !== -1) return i; }
      return -1;
    };

    // è§£æå•å…ƒæ ¼ï¼šâ€œè½¦ | é‡‘é¢ | å¤‡æ³¨ || è½¦ | é‡‘é¢ â€¦â€
    function parseCellEntries(cell) {
      const out = [];
      if (!cell) return out;
      String(cell).split('||').map(s=>s.trim()).filter(Boolean).forEach(one=>{
        const p = one.split('|').map(x=>x.trim());
        out.push({ car: p[0]||'', amount: p[1]||'', note: p[2]||'', raw: one });
      });
      return out;
    }

    // Cloudinary ä»£ç†æœç´¢ï¼ˆæ–°åç«¯ï¼šexprï¼‰
    async function cloudSearchByExpr(expr, limit = 100){
      const url = `${BACKEND}/cloudinary-search?expr=${encodeURIComponent(expr)}&limit=${limit}`;
      const r = await fetch(url);
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
      return j;
    }

    /* ============ Tab ============ */
    const tabByDate = document.getElementById('tabByDate');
    const tabByCar  = document.getElementById('tabByCar');
    const panelDate = document.getElementById('panelDate');
    const panelCar  = document.getElementById('panelCar');
    tabByDate.addEventListener('click', ()=>{ panelDate.classList.remove('hidden'); panelCar.classList.add('hidden'); });
    tabByCar .addEventListener('click', ()=>{ panelCar .classList.remove('hidden'); panelDate.classList.add('hidden'); });

    /* ============ æŒ‰æ—¥æœŸ ============ */
    document.getElementById('btnLoadA').addEventListener('click', loadByDate);

    async function loadByDate(){
      const hdr = document.getElementById('dateHdrRawA').value; // YYYY-MM-DD
      const cat = document.getElementById('catFilterA').value;
      const list = document.getElementById('listA');
      const pics = document.getElementById('picsA');
      const msg  = document.getElementById('msgA');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';

      if (!hdr) { msg.textContent = 'è¯·é€‰æ‹©æ—¥æœŸ'; return; }

      // éª¨æ¶åŠ è½½
      pics.innerHTML = '<div class="col-span-full grid grid-cols-4 gap-2">'
        + Array.from({length:8}).map(()=>'<div class="h-24 rounded-lg bg-zinc-900 animate-pulse"></div>').join('')
        + '</div>';

      // 1) å–å½“æ—¥å„é¡¹ç›®æ–‡å­—è®°å½•
      let items = null;
      try{
        const r = await fetch(`${BACKEND}/sheet4-day?date=${encodeURIComponent(hdr)}`);
        const j = await r.json();
        if (r.ok && j.ok) items = j.items || [];
      }catch{}

      // è‹¥åç«¯æ²¡å¼€ /sheet4-dayï¼Œåˆ™å…œåº•ä» /sheet4 å‰ç«¯è§£æ
      if (!items) {
        try{
          const r = await fetch(`${BACKEND}/sheet4`);
          const j = await r.json();
          const values = j.values || [];
          if (!values.length) throw new Error('Sheet4 ä¸ºç©º');

          const header = values[0] || [];
          // è¡¨å¤´é‡Œå…è®¸ â€œ9/1ã€9æœˆ1æ—¥ã€09-01â€¦â€ï¼šæ„é€ å€™é€‰
          const d = new Date(hdr);
          const m = d.getMonth()+1, day = d.getDate();
          const candidates = new Set([
            `${m}/${day}`, `${pad2(m)}/${pad2(day)}`,
            `${m}-${day}`, `${pad2(m)}-${pad2(day)}`,
            `${m}.${day}`, `${pad2(m)}.${pad2(day)}`,
            `${m}æœˆ${day}æ—¥`
          ]);

          let colIndex = -1;
          for (let c=1;c<header.length;c++) {
            const cell = String(header[c]||'').trim();
            if (candidates.has(cell)) { colIndex = c; break; }
          }
          if (colIndex === -1) throw new Error('æœªæ‰¾åˆ°è¯¥æ—¥æœŸåˆ—');

          items = [];
          for (let rIdx=1;rIdx<values.length;rIdx++) {
            items.push({ project: values[rIdx]?.[0] || '', value: values[rIdx]?.[colIndex] || '' });
          }
        }catch(e){
          msg.textContent = 'è¯»å–æ—¥æœŸè®°å½•å¤±è´¥';
        }
      }

      // ç±»åˆ«ç­›é€‰
      if (cat) items = (items||[]).filter(x => String(x.project).trim() === String(cat).trim());

      // 2) å·¦ä¾§æ¸²æŸ“æ–‡å­—
      let rec = 0;
      for (const it of (items||[])) {
        for (const e of parseCellEntries(it.value)) {
          const div = document.createElement('div');
          div.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
          const amount = e.amount ? ` Â· $${e.amount}` : '';
          const note   = e.note   ? ` Â· ${e.note}` : '';
          div.innerHTML = `
            <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${it.project}</span>
            <span class="opacity-90">${e.car || '(æ— è½¦å‹)'}${amount}${note}</span>
          `;
          list.appendChild(div);
          rec++;
        }
      }
      if (!rec) list.innerHTML = '<div class="text-xs opacity-70">è¯¥æ—¥æœŸ / ç±»åˆ«ä¸‹æš‚æ— è®°å½•</div>';

      // 3) å³ä¾§æŒ‰â€œæ—¥æœŸâ€æŸ¥å›¾ç‰‡ï¼špublic_id:*__YYYY-MM-DD__*
      try{
        const expr = `public_id="*__${hdr}__*"`;
        const res = await cloudSearchByExpr(expr, 200);
        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const a = document.createElement('a');
          a.href = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
          a.target = '_blank'; a.rel = 'noopener';
          const el = document.createElement('img');
          el.src = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_600,h_420,q_auto,f_auto/${img.public_id}.jpg`;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
          a.appendChild(el);
          pics.appendChild(a);
        });
        if (!pics.children.length) pics.innerHTML = '<div class="text-xs opacity-70">æœªæ‰¾åˆ°è¯¥æ—¥æœŸçš„ç…§ç‰‡</div>';
      }catch(e){
        pics.innerHTML = '<div class="text-xs opacity-70">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
      }
    }

    /* ============ æŒ‰è½¦å‹ ============ */
    // è½½å…¥è½¦å‹åˆ—è¡¨ï¼ˆSheet5ï¼‰
    (async function loadCarsForB(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if (!ok || !values.length) throw new Error('Sheet5 ä¸ºç©º');

        const [header, ...rows] = values;
        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelectB');
        rows.forEach(row=>{
          const stock = row[stockIdx] || '';
          if (!stock) return;
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          const label = `${stock} ${year} ${make} ${model}`.trim();
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model,label});
          opt.textContent = `${stock} Â· ${year} ${make} ${model}`;
          sel.appendChild(opt);
        });
      }catch{
        document.getElementById('carSelectB').innerHTML = '<option>åŠ è½½å¤±è´¥</option>';
      }
    })();

    document.getElementById('btnLoadB').addEventListener('click', loadByCar);

    async function loadByCar(){
      const val = document.getElementById('carSelectB').value;
      const list = document.getElementById('listB');
      const pics = document.getElementById('picsB');
      const msg  = document.getElementById('msgB');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';
      if (!val) { msg.textContent = 'è¯·é€‰æ‹©è½¦å‹'; return; }
      const car = JSON.parse(val);

      // å³ï¼šæŒ‰å‰ç¼€ public_id: <stock>_<year>_<make>_<model>__*
      try{
        const prefix = `${toSlug(car.stock)}_${toSlug(car.year)}_${toSlug(car.make)}_${toSlug(car.model)}__`;
        const expr = `public_id="${prefix}*"`;
        // éª¨æ¶
        pics.innerHTML = '<div class="col-span-full grid grid-cols-4 gap-2">'
          + Array.from({length:8}).map(()=>'<div class="h-24 rounded-lg bg-zinc-900 animate-pulse"></div>').join('')
          + '</div>';
        const res = await cloudSearchByExpr(expr, 300);
        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const a = document.createElement('a');
          a.href = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
          a.target = '_blank'; a.rel = 'noopener';
          const el = document.createElement('img');
          el.src = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_600,h_420,q_auto,f_auto/${img.public_id}.jpg`;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
          a.appendChild(el);
          pics.appendChild(a);
        });
        if (!pics.children.length) pics.innerHTML = '<div class="text-xs opacity-70">è¯¥è½¦æš‚æ— ç…§ç‰‡</div>';
      }catch{
        pics.innerHTML = '<div class="text-xs opacity-70">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
      }

      // å·¦ï¼šä» Sheet4 æ‰«æè¯¥è½¦çš„æ‰€æœ‰è®°å½•
      try{
        let values;
        try {
          const rr = await fetch(`${BACKEND}/sheet4`);
          const jj = await rr.json();
          values = jj.values || [];
        } catch {}
        if (!values || !values.length) { list.textContent = 'Sheet4 ä¸ºç©º'; return; }

        const header = values[0] || [];
        const dateHeaders = header.slice(1).map(h => String(h||'').trim());
        const carKey = `${car.stock} ${car.year} ${car.make} ${car.model}`.trim().toLowerCase();

        // éª¨æ¶
        list.innerHTML = Array.from({length:4}).map(()=>(
          '<div class="rounded-lg border border-sjgold/10 p-2 bg-zinc-900 animate-pulse h-10"></div>'
        )).join('');

        let rendered = 0;
        const frag = document.createDocumentFragment();
        for (let r=1; r<values.length; r++) {
          const project = (values[r][0]||'').trim();
          for (let c=1; c<header.length; c++) {
            const entries = parseCellEntries(values[r][c] || '');
            const mine = entries.filter(e => (e.car||'').trim().toLowerCase() === carKey);
            for (const e of mine) {
              const row = document.createElement('div');
              row.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
              row.innerHTML = `
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${dateHeaders[c-1]}</span>
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${project}</span>
                <span class="opacity-90">$${e.amount || ''}</span>
                ${e.note ? `<span class="opacity-70"> Â· ${e.note}</span>` : ''}
              `;
              frag.appendChild(row);
              rendered++;
            }
          }
        }
        list.innerHTML = '';
        list.appendChild(frag);
        if (!rendered) list.textContent = 'è¯¥è½¦æš‚æ— è´¹ç”¨è®°å½•';
      }catch{
        list.textContent = 'è®°å½•åŠ è½½å¤±è´¥';
      }
    }

    /* ============ é»˜è®¤ï¼šç»™æ—¥æœŸæ§ä»¶ä¸€ä¸ªä»Šå¤© ============ */
    (function setToday(){
      const t = new Date();
      const val = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
      const input = document.getElementById('dateHdrRawA');
      if (!input.value) input.value = val;
    })();
  </script>
</body>
</html>
