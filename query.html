<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto · 查询</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{ extend:{
        colors:{ sjgold:'#FFD700' },
        boxShadow: {
          soft: '0 6px 24px rgba(255,215,0,0.08), 0 2px 8px rgba(0,0,0,0.25)'
        }
      } }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold/90 antialiased">
  <!-- 顶部栏 -->
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-sjgold/10 ring-1 ring-sjgold/20">📊</span>
        <h1 class="text-lg sm:text-xl font-semibold tracking-wide">查询 · 费用 & 照片</h1>
      </div>
      <nav class="text-sm flex gap-3">
        <a href="index.html" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">录入</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- 顶部切换 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-3.5">
        <div class="flex items-center gap-2">
          <button id="tabByDate" class="px-4 h-10 rounded-xl border border-sjgold/30 bg-sjgold text-black font-medium shadow-soft">按日期</button>
          <button id="tabByCar"  class="px-4 h-10 rounded-xl border border-sjgold/30 hover:bg-zinc-900">按车型</button>
          <span class="text-xs opacity-70 ml-auto">小提示：点击图片可在新标签打开原图</span>
        </div>
      </div>
      <!-- 搜索框（车型模式的小过滤） -->
      <div class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-3.5">
        <div class="flex items-center gap-2">
          <span class="text-xs opacity-70">快速筛车</span>
          <input id="quickCarFilter" placeholder="输入 Stock / Make / Model..."
                 class="flex-1 rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500 text-sm"/>
        </div>
      </div>
    </div>

    <!-- ================= 模式 A：按日期 ================= -->
    <section id="panelDate" class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm opacity-80">选择日期（来自 Sheet4 表头）</div>
            <div class="flex items-center gap-2">
              <button id="calPrevA" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">←</button>
              <div id="calTitleA" class="text-sm font-semibold"></div>
              <button id="calNextA" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">→</button>
            </div>
          </div>
          <div class="grid grid-cols-7 text-xs opacity-70 mb-1">
            <div class="text-center py-1">Mon</div><div class="text-center py-1">Tue</div><div class="text-center py-1">Wed</div>
            <div class="text-center py-1">Thu</div><div class="text-center py-1">Fri</div><div class="text-center py-1">Sat</div><div class="text-center py-1">Sun</div>
          </div>
          <div id="calGridA" class="grid grid-cols-7 gap-1"></div>
          <input id="dateHdrRawA" type="hidden" />
          <p id="calHintA" class="text-xs opacity-70 mt-1"></p>
        </div>
        <div class="bg-black/40 rounded-xl ring-1 ring-sjgold/20 p-3">
          <div class="space-y-3">
            <label class="block text-sm">费用类别筛选</label>
            <select id="catFilterA" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none">
              <option value="">（全部）</option>
              <option>税前买入金额</option>
              <option>买断金额（lease）</option>
              <option>车主证过户费用</option>
              <option>转lease费用/买断费用</option>
              <option>检修费用</option>
              <option>加油费用</option>
              <option>上牌费用</option>
              <option>银行手续费</option>
              <option>客户返佣</option>
              <option>中介返佣</option>
              <option>员工激励</option>
            </select>
            <button id="btnLoadA" class="w-full h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">加载</button>
            <div id="msgA" class="text-xs opacity-80"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <div class="text-sm mb-2 opacity-80">记录</div>
          <div id="listA" class="space-y-2"></div>
        </div>
        <div>
          <div class="text-sm mb-2 opacity-80">图片</div>
          <div id="picsA" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
    </section>

    <!-- ================= 模式 B：按车型 ================= -->
    <section id="panelCar" class="hidden bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">选择车型（来自 Sheet5）</label>
            <select id="carSelectB" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none"></select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnLoadB" class="px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">加载</button>
            <span id="msgB" class="text-sm opacity-80"></span>
          </div>
        </div>
        <div class="bg-black/40 rounded-xl ring-1 ring-sjgold/20 p-3">
          <div class="text-xs opacity-75">提示：右侧显示该车型所有照片；左侧列出该车在 Sheet4 的每条费用记录。</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <div class="text-sm mb-2 opacity-80">该车费用记录（全部日期）</div>
          <div id="listB" class="space-y-2"></div>
        </div>
        <div>
          <div class="text-sm mb-2 opacity-80">该车所有照片</div>
          <div id="picsB" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    async function cloudSearchByExpr(expr, limit = 100) {
      const url = `${BACKEND}/cloudinary-search?expr=${encodeURIComponent(expr)}&limit=${limit}`;
      const r = await fetch(url);
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
      return j;
    }

    /* ---- 日期模式 loadByDate 修改 ---- */
    async function loadByDate(){
      const hdr = document.getElementById('dateHdrRawA').value;
      const pics= document.getElementById('picsA');
      const list= document.getElementById('listA');
      const msg = document.getElementById('msgA');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';
      if(!hdr){ msg.textContent='请选择日期'; return; }

      const dateISO = hdr; // 你已有转换函数可用
      // 👉 改成冒号+引号的 Cloudinary 表达式
      const exprForDate = `public_id:*__${dateISO}__*`;

      try{
        const res = await cloudSearchByExpr(exprForDate);
        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const url = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_500,h_350,q_auto,f_auto/${img.public_id}.jpg`;
          const el = document.createElement('img');
          el.src = url;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20';
          pics.appendChild(el);
        });
      }catch(e){ msg.textContent='图片加载失败'; }
    }

    /* ---- 车型模式 loadByCar 修改 ---- */
    async function loadByCar(){
      const selVal = document.getElementById('carSelectB').value;
      const pics= document.getElementById('picsB');
      const msg = document.getElementById('msgB');
      pics.innerHTML=''; msg.textContent='';
      if(!selVal){ msg.textContent='请选择车型'; return; }
      const car = JSON.parse(selVal);

      // 👉 改成冒号+引号
      const prefix  = `${car.stock}_${car.year}_${car.make}_${car.model}__`;
      const expr = `public_id:"${prefix}*"`;

      try{
        const res = await cloudSearchByExpr(expr);
        (res.resources || []).forEach(img=>{
          const url = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_500,h_350,q_auto,f_auto/${img.public_id}.jpg`;
          const el = document.createElement('img');
          el.src = url;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20';
          pics.appendChild(el);
        });
      }catch(e){ msg.textContent='图片加载失败'; }
    }
  </script>
</body>
</html>
