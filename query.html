<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto Â· æŸ¥è¯¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{ extend:{
        colors:{ sjgold:'#FFD700' },
        boxShadow:{ soft:'0 6px 24px rgba(255,215,0,0.08), 0 2px 8px rgba(0,0,0,0.25)' }
      } }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold/90 antialiased">
  <!-- é¡¶éƒ¨æ  -->
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-sjgold/10 ring-1 ring-sjgold/20">ğŸ“Š</span>
        <h1 class="text-lg sm:text-xl font-semibold tracking-wide">æŸ¥è¯¢ Â· è´¹ç”¨ & ç…§ç‰‡</h1>
      </div>
      <nav class="text-sm flex gap-3">
        <a href="index.html" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">å½•å…¥</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- é¡¶éƒ¨åˆ‡æ¢ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-3.5">
        <div class="flex items-center gap-2">
          <button id="tabByDate" class="px-4 h-10 rounded-xl border border-sjgold/30 bg-sjgold text-black font-medium shadow-soft">æŒ‰æ—¥æœŸ</button>
          <button id="tabByCar"  class="px-4 h-10 rounded-xl border border-sjgold/30 hover:bg-zinc-900">æŒ‰è½¦å‹</button>
          <span class="text-xs opacity-70 ml-auto">å°æç¤ºï¼šç‚¹å‡»å›¾ç‰‡å¯åœ¨æ–°æ ‡ç­¾æ‰“å¼€åŸå›¾</span>
        </div>
      </div>
      <!-- æœç´¢æ¡†ï¼ˆè½¦å‹æ¨¡å¼çš„å°è¿‡æ»¤ï¼‰ -->
      <div class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-3.5">
        <div class="flex items-center gap-2">
          <span class="text-xs opacity-70">å¿«é€Ÿç­›è½¦</span>
          <input id="quickCarFilter" placeholder="è¾“å…¥ Stock / Make / Model..."
                 class="flex-1 rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none focus:ring-2 focus:ring-yellow-500 text-sm"/>
        </div>
      </div>
    </div>

    <!-- ================= æ¨¡å¼ Aï¼šæŒ‰æ—¥æœŸ ================= -->
    <section id="panelDate" class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm opacity-80">é€‰æ‹©æ—¥æœŸï¼ˆæ¥è‡ª Sheet4 è¡¨å¤´ï¼‰</div>
            <div class="flex items-center gap-2">
              <button id="calPrevA" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">â†</button>
              <div id="calTitleA" class="text-sm font-semibold"></div>
              <button id="calNextA" type="button" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">â†’</button>
            </div>
          </div>
          <div class="grid grid-cols-7 text-xs opacity-70 mb-1">
            <div class="text-center py-1">Mon</div><div class="text-center py-1">Tue</div><div class="text-center py-1">Wed</div>
            <div class="text-center py-1">Thu</div><div class="text-center py-1">Fri</div><div class="text-center py-1">Sat</div><div class="text-center py-1">Sun</div>
          </div>
          <div id="calGridA" class="grid grid-cols-7 gap-1"></div>
          <input id="dateHdrRawA" type="hidden" />
          <p id="calHintA" class="text-xs opacity-70 mt-1"></p>
        </div>
        <div class="bg-black/40 rounded-xl ring-1 ring-sjgold/20 p-3">
          <div class="space-y-3">
            <label class="block text-sm">è´¹ç”¨ç±»åˆ«ç­›é€‰</label>
            <select id="catFilterA" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none">
              <option value="">ï¼ˆå…¨éƒ¨ï¼‰</option>
              <option>ç¨å‰ä¹°å…¥é‡‘é¢</option>
              <option>ä¹°æ–­é‡‘é¢ï¼ˆleaseï¼‰</option>
              <option>è½¦ä¸»è¯è¿‡æˆ·è´¹ç”¨</option>
              <option>è½¬leaseè´¹ç”¨/ä¹°æ–­è´¹ç”¨</option>
              <option>æ£€ä¿®è´¹ç”¨</option>
              <option>åŠ æ²¹è´¹ç”¨</option>
              <option>ä¸Šç‰Œè´¹ç”¨</option>
              <option>é“¶è¡Œæ‰‹ç»­è´¹</option>
              <option>å®¢æˆ·è¿”ä½£</option>
              <option>ä¸­ä»‹è¿”ä½£</option>
              <option>å‘˜å·¥æ¿€åŠ±</option>
            </select>
            <button id="btnLoadA" class="w-full h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">åŠ è½½</button>
            <div id="msgA" class="text-xs opacity-80"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <div class="text-sm mb-2 opacity-80">è®°å½•</div>
          <div id="listA" class="space-y-2"></div>
        </div>
        <div>
          <div class="text-sm mb-2 opacity-80">å›¾ç‰‡</div>
          <div id="picsA" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
    </section>

    <!-- ================= æ¨¡å¼ Bï¼šæŒ‰è½¦å‹ ================= -->
    <section id="panelCar" class="hidden bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">é€‰æ‹©è½¦å‹ï¼ˆæ¥è‡ª Sheet5ï¼‰</label>
            <select id="carSelectB" class="w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 outline-none"></select>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnLoadB" class="px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">åŠ è½½</button>
            <span id="msgB" class="text-sm opacity-80"></span>
          </div>
        </div>
        <div class="bg-black/40 rounded-xl ring-1 ring-sjgold/20 p-3">
          <div class="text-xs opacity-75">æç¤ºï¼šå³ä¾§æ˜¾ç¤ºè¯¥è½¦å‹æ‰€æœ‰ç…§ç‰‡ï¼›å·¦ä¾§åˆ—å‡ºè¯¥è½¦åœ¨ Sheet4 çš„æ¯æ¡è´¹ç”¨è®°å½•ã€‚</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <div class="text-sm mb-2 opacity-80">è¯¥è½¦è´¹ç”¨è®°å½•ï¼ˆå…¨éƒ¨æ—¥æœŸï¼‰</div>
          <div id="listB" class="space-y-2"></div>
        </div>
        <div>
          <div class="text-sm mb-2 opacity-80">è¯¥è½¦æ‰€æœ‰ç…§ç‰‡</div>
          <div id="picsB" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ==================== å¸¸é‡ ==================== */
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    /* ==================== å°å·¥å…· ==================== */
    const normalize = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const getCol = (headers, candidates) => {
      const map = headers.map(h => normalize(h));
      for (const c of candidates) {
        const i = map.indexOf(normalize(c));
        if (i !== -1) return i;
      }
      return -1;
    };
    const toSlug = (s) => {
      if (!s) return '';
      let t = String(s).trim();
      t = t.normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
           .replace(/\s+/g, '-')
           .replace(/[&:ï¼šã€ï¼Œ,.;ã€‚\/\\]+/g, '-')
           .toLowerCase();
      t = t.replace(/[^a-z0-9\u4e00-\u9fa5_-]/g, '-').replace(/-+/g, '-').replace(/(^-|-$)/g, '');
      return t || 'x';
    };
    const pad2 = n => String(n).padStart(2,'0');

    // â€œ9æœˆ1æ—¥ / 9/1 / 2025-09-01 / ä»…â€˜1â€™â€ -> å½“å¹´ ISO
    function toISOFromHeader(hdr){
      const now = new Date(), year = now.getFullYear();
      let m=null,d=null;
      const zh = String(hdr).match(/(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
      if(zh){ m=+zh[1]; d=+zh[2]; }
      if(m===null || d===null){
        let t = String(hdr).replace(/\s+/g,'').replace(/[.\-]/g,'/');
        const md = t.match(/(\d{1,2})\/(\d{1,2})/);
        if(md){ m=+md[1]; d=+md[2]; }
        else if(/^\d{1,2}$/.test(t)){ d=+t; m = now.getMonth()+1; }
      }
      if(!m || !d){ m = now.getMonth()+1; d = now.getDate(); }
      return `${year}-${pad2(m)}-${pad2(d)}`;
    }

    // è§£æå•å…ƒæ ¼ â€œè½¦ | é‡‘é¢ | å¤‡æ³¨ || è½¦ | é‡‘é¢ â€¦â€
    function parseCellEntries(cell){
      const out = [];
      if(!cell) return out;
      String(cell).split('||').map(s=>s.trim()).filter(Boolean).forEach(one=>{
        const parts = one.split('|').map(x=>x.trim());
        out.push({car:(parts[0]||''), amount:(parts[1]||''), note:(parts[2]||''), raw:one});
      });
      return out;
    }

    // è½¦å‹è¡Œ -> å¯¹è±¡
    function splitCarLine(carLine){
      if(!carLine) return {stock:'',year:'',make:'',model:''};
      const seg = carLine.split(/\s+/).filter(Boolean);
      return { stock: seg[0]||'', year: seg[1]||'', make: seg[2]||'', model: seg.slice(3).join(' ')||'' };
    }

    // åç«¯ä»£ç† Cloudinary Searchï¼ˆexpr é€ä¼ ï¼‰
   // ç»Ÿä¸€ç”¨è¿™ä¸ª
async function cloudSearchByExpr(expr, limit = 200) {
  // è¿™é‡Œ expr ä¸è¦å¸¦å¼•å·ï¼›å½¢å¦‚ public_id=*__2025-08-22__*
  const url = `${BACKEND}/cloudinary-search?expr=${encodeURIComponent(expr)}&limit=${limit}`;
  const r = await fetch(url);
  const j = await r.json();
  if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
  return j;
}

    /* ==================== Tab åˆ‡æ¢ ==================== */
    const tabByDate = document.getElementById('tabByDate');
    const tabByCar  = document.getElementById('tabByCar');
    const panelDate = document.getElementById('panelDate');
    const panelCar  = document.getElementById('panelCar');

    tabByDate.addEventListener('click', () => {
      tabByDate.classList.add('bg-sjgold','text-black','shadow-soft');
      tabByCar.classList.remove('bg-sjgold','text-black','shadow-soft');
      panelDate.classList.remove('hidden');
      panelCar.classList.add('hidden');
    });
    tabByCar.addEventListener('click', () => {
      tabByCar.classList.add('bg-sjgold','text-black','shadow-soft');
      tabByDate.classList.remove('bg-sjgold','text-black','shadow-soft');
      panelCar.classList.remove('hidden');
      panelDate.classList.add('hidden');
    });

    /* ==================== æŒ‰æ—¥æœŸæ—¥å† ==================== */
    let S4_HEADERS_RAW_A = [];
    let S4_PARSED_A = [];
    let CAL_YEAR_A, CAL_MONTH_A;
    let SELECTED_HDR_RAW_A = '';

    function parseHeaderMD(h){
      const s = String(h||'').trim();
      let m = s.match(/(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
      if(m) return { month:+m[1], day:+m[2] };
      const t = s.replace(/[.\-]/g,'/'); m = t.match(/(\d{1,2})\/(\d{1,2})/);
      if(m) return { month:+m[1], day:+m[2] };
      if(/^\d{1,2}$/.test(s)) return { month:null, day:+s };
      return { month:null, day:null };
    }

    async function loadDatesFromSheet4(){
      const r = await fetch(`${BACKEND}/sheet4`);
      const { ok, values=[] } = await r.json();
      if(!ok || !values.length) throw new Error('Sheet4 ä¸ºç©º');
      const header = values[0] || [];
      S4_HEADERS_RAW_A = header.slice(1).map(v => String(v||'').trim());
      S4_PARSED_A = S4_HEADERS_RAW_A.map(raw => ({ raw, ...parseHeaderMD(raw) }));

      const today = new Date();
      CAL_YEAR_A = today.getFullYear();
      const months = S4_PARSED_A.map(x=>x.month).filter(m=>m!=null);
      CAL_MONTH_A = months.length ? (months.includes(today.getMonth()+1) ? (today.getMonth()+1) : months[0]) : (today.getMonth()+1);
      renderCalendarA();
      autoPickTodayA();
      // ç¼“å­˜æ•´è¡¨ä¾›è½¦å‹æ¨¡å¼ä½¿ç”¨
      window.__SHEET4_CACHE__ = values;
    }

    function renderCalendarA(){
      const grid  = document.getElementById('calGridA');
      const title = document.getElementById('calTitleA');
      const hint  = document.getElementById('calHintA');
      title.textContent = `${CAL_YEAR_A}-${pad2(CAL_MONTH_A)}`;

      const first = new Date(CAL_YEAR_A, CAL_MONTH_A-1, 1);
      const startCol = (first.getDay()+6)%7;
      const days = new Date(CAL_YEAR_A, CAL_MONTH_A, 0).getDate();

      grid.innerHTML = '';
      for(let i=0;i<startCol;i++) grid.appendChild(document.createElement('div'));

      for(let d=1; d<=days; d++){
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='relative w-full aspect-square rounded-lg border border-sjgold/20 hover:border-sjgold/50 text-sm transition';
        const match = S4_PARSED_A.find(x => x.month===CAL_MONTH_A && x.day===d)
                   || S4_PARSED_A.find(x => x.month==null && x.day===d);
        btn.textContent = d;
        if(match){
          btn.onclick = ()=>{ SELECTED_HDR_RAW_A = match.raw; document.getElementById('dateHdrRawA').value = match.raw; renderCalendarA(); };
          if(SELECTED_HDR_RAW_A && match.raw===SELECTED_HDR_RAW_A)
            btn.classList.add('bg-sjgold','text-black','font-semibold','shadow-soft');
        }else{
          btn.classList.add('opacity-40','cursor-not-allowed');
        }
        const t = new Date();
        if(t.getFullYear()===CAL_YEAR_A && t.getMonth()+1===CAL_MONTH_A && t.getDate()===d)
          btn.classList.add('ring-1','ring-sjgold/60');
        grid.appendChild(btn);
      }
      const onlyDay = S4_PARSED_A.every(x => x.month==null || x.month===CAL_MONTH_A);
      hint.textContent = onlyDay ? 'æç¤ºï¼šè¡¨å¤´å¤šä¸ºâ€œä»…æ—¥â€ï¼Œæœˆä»½åˆ‡æ¢åªå½±å“æ˜¾ç¤ºã€‚' : 'é€‰æ‹©æœˆä»½ååœ¨æ—¥å†ä¸­ç‚¹å…·ä½“æ—¥æœŸã€‚';
    }

    function autoPickTodayA(){
      const t = new Date();
      const raw = (S4_PARSED_A.find(x => x.month===CAL_MONTH_A && x.day===t.getDate())
                || S4_PARSED_A.find(x => x.month==null && x.day===t.getDate()))?.raw;
      if(raw){ SELECTED_HDR_RAW_A = raw; document.getElementById('dateHdrRawA').value = raw; renderCalendarA(); }
    }

    document.getElementById('calPrevA').addEventListener('click', ()=>{ CAL_MONTH_A--; if(CAL_MONTH_A===0){CAL_MONTH_A=12;CAL_YEAR_A--;} renderCalendarA(); });
    document.getElementById('calNextA').addEventListener('click', ()=>{ CAL_MONTH_A++; if(CAL_MONTH_A===13){CAL_MONTH_A=1;CAL_YEAR_A++;} renderCalendarA(); });

// ==================== æŒ‰æ—¥æœŸåŠ è½½ ====================
document.getElementById('btnLoadA').addEventListener('click', loadByDate);

async function loadByDate() {
  const hdr = document.getElementById('dateHdrRawA').value;
  const cat = document.getElementById('catFilterA').value;
  const msg = document.getElementById('msgA');
  const list= document.getElementById('listA');
  const pics= document.getElementById('picsA');

  list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';
  if (!hdr) { msg.textContent = 'è¯·é€‰æ‹©æ—¥æœŸ'; return; }

  const dateISO = toISOFromHeader(hdr);

  // éª¨æ¶
  pics.innerHTML = '<div class="col-span-full grid grid-cols-4 gap-2">'
    + Array.from({length:8}).map(()=>'<div class="h-24 rounded-lg bg-zinc-900 animate-pulse"></div>').join('')
    + '</div>';

  // å…ˆæ‹‰å½“å¤©å„é¡¹ç›®æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
  let items = null;
  try {
    const r = await fetch(`${BACKEND}/sheet4-day?date=${encodeURIComponent(dateISO)}`);
    const j = await r.json();
    if (r.ok && j.ok) items = j.items || [];
  } catch {}

  if (!items) {
    const values = window.__SHEET4_CACHE__;
    if (!values || !values.length) { msg.textContent = 'è¡¨ç¼“å­˜æœªå°±ç»ªï¼Œè¯·åˆ·æ–°'; pics.innerHTML=''; return; }
    const header = values[0] || [];
    let colIndex = -1;
    for (let c = 1; c < header.length; c++) {
      const cell = String(header[c]||'').trim();
      const t  = hdr.replace(/\./g,'/').replace(/-/g,'/').replace(/æœˆ|æ—¥/g,'/').replace(/\/$/,'');
      if (cell === hdr || cell === t) { colIndex = c; break; }
    }
    if (colIndex === -1) { msg.textContent='æœªæ‰¾åˆ°è¯¥æ—¥æœŸåˆ—'; pics.innerHTML=''; return; }
    items = [];
    for (let r = 1; r < values.length; r++) {
      items.push({ project: values[r]?.[0] || '', value: values[r]?.[colIndex] || '' });
    }
  }

  // å¯é€‰ï¼šæŒ‰ç±»åˆ«è¿‡æ»¤
  if (cat) items = items.filter(x => String(x.project).trim() === String(cat).trim());

  // å·¦ä¾§è®°å½•
  let counter = 0;
  for (const it of items) {
    const entries = parseCellEntries(it.value);
    for (const e of entries) {
      const div = document.createElement('div');
      div.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
      const car = e.car || '(æ— è½¦å‹)';
      const amount = e.amount ? ` Â· $${e.amount}` : '';
      const note = e.note ? ` Â· ${e.note}` : '';
      div.innerHTML = `<span class="inline-flex items-center gap-2">
        <span class="px-2 py-0.5 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${it.project}</span>
        <span class="opacity-90">${car}${amount}${note}</span>
      </span>`;
      list.appendChild(div);
      counter++;
    }
  }
  if (!counter) { msg.textContent = 'è¯¥æ—¥æœŸ / ç±»åˆ«ä¸‹æš‚æ— è®°å½•'; pics.innerHTML=''; return; }

 // === å³ä¾§å›¾ç‰‡ï¼šç°åœ¨åªç»™åç«¯ä¸€ä¸ª dateï¼Œåç«¯æå®šè¡¨è¾¾å¼ ===
let res;
try {
  res = await cloudSearchByDate(dateISO, 200);
} catch (e) {
  msg.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
  res = { resources: [] };
}

pics.innerHTML = '';
(res.resources || []).forEach(img => {
  const urlThumb = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_500,h_350,q_auto,f_auto/${img.public_id}.jpg`;
  const urlRaw   = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
  const a = document.createElement('a');
  a.href = urlRaw; a.target = '_blank'; a.rel='noopener';
  const el = document.createElement('img');
  el.src = urlThumb; el.alt = img.public_id;
  el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
  a.appendChild(el);
  pics.appendChild(a);
});
if (!pics.children.length) {
  pics.innerHTML = '<div class="text-xs opacity-70">æœªæ‰¾åˆ°è¯¥æ—¥æœŸçš„ç…§ç‰‡</div>';
}
}


    /* ==================== è½¦å‹æ¨¡å¼ ==================== */
    const quickCarFilter = document.getElementById('quickCarFilter');

    async function loadCarsForB(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if(!ok || !values.length) throw new Error('Sheet5 ä¸ºç©º');
        const [header, ...rows] = values;
        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelectB');
        sel.innerHTML = '';
        rows.forEach(row => {
          const stock = row[stockIdx] || '';
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          if(!stock) return;
          const label = `${stock} Â· ${year} ${make} ${model}`.trim();
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model,label});
          opt.textContent = label;
          sel.appendChild(opt);
        });

        // å¿«é€Ÿç­›é€‰
        quickCarFilter.addEventListener('input', ()=>{
          const q = quickCarFilter.value.trim().toLowerCase();
          for (const opt of sel.options) {
            const show = !q || opt.textContent.toLowerCase().includes(q);
            opt.hidden = !show;
          }
          const firstVisible = Array.from(sel.options).find(o=>!o.hidden);
          if(firstVisible) sel.value = firstVisible.value;
        });
      }catch{
        document.getElementById('carSelectB').innerHTML = '<option>åŠ è½½å¤±è´¥</option>';
      }
    }

    document.getElementById('btnLoadB').addEventListener('click', loadByCar);
    async function loadByCar(){
      const selVal = document.getElementById('carSelectB').value;
      const msg = document.getElementById('msgB');
      const list= document.getElementById('listB');
      const pics= document.getElementById('picsB');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';
      if(!selVal){ msg.textContent='è¯·é€‰æ‹©è½¦å‹'; return; }
      const car = JSON.parse(selVal);

      // å³ï¼šè¯¥è½¦æ‰€æœ‰ç…§ç‰‡ï¼ˆä»¥ â€œStock_Year_Make_Model__â€ ä½œä¸ºå‰ç¼€ï¼‰
      try{
        const prefix  = `${toSlug(car.stock)}_${toSlug(car.year)}_${toSlug(car.make)}_${toSlug(car.model)}__`;
        const expr = `public_id:${prefix}*`;   // âœ… æ­£ç¡®è¯­æ³•
        const res = await cloudSearchByExpr(expr, 200);

        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const urlThumb = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_500,h_350,q_auto,f_auto/${img.public_id}.jpg`;
          const urlRaw   = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
          const a = document.createElement('a');
          a.href = urlRaw; a.target = '_blank'; a.rel='noopener';
          const el = document.createElement('img');
          el.src = urlThumb; el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
          a.appendChild(el);
          pics.appendChild(a);
        });
        if(!pics.children.length){
          pics.innerHTML = '<div class="text-xs opacity-70">è¯¥è½¦æš‚æ— ç…§ç‰‡</div>';
        }
      }catch{
        pics.innerHTML = '<div class="text-xs opacity-70">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
      }

      // å·¦ï¼šè¯¥è½¦åœ¨ Sheet4 çš„æ‰€æœ‰è®°å½•ï¼ˆæ‰«ææ•´è¡¨ï¼‰
      try{
        let values = window.__SHEET4_CACHE__;
        if(!values){
          const rr = await fetch(`${BACKEND}/sheet4`);
          const jj = await rr.json();
          if(jj.ok) values = jj.values;
        }
        if(!values || !values.length){ list.textContent='Sheet4 ä¸ºç©º'; return; }

        const header = values[0] || [];
        const dateHeaders = header.slice(1).map(h => String(h||'').trim());
        const carKeyPrefix = `${car.stock} ${car.year} ${car.make} ${car.model}`.trim().toLowerCase();

        let rendered = 0;
        const frag = document.createDocumentFragment();
        for(let r=1;r<values.length;r++){
          const project = (values[r][0]||'').trim(); // è¡Œå¤´=é¡¹ç›®
          for(let c=1;c<header.length;c++){
            const cell = values[r][c] || '';
            const entries = parseCellEntries(cell);
            const mine = entries.filter(e => (e.car||'').trim().toLowerCase() === carKeyPrefix);
            for(const e of mine){
              const row = document.createElement('div');
              row.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
              row.innerHTML = `
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${dateHeaders[c-1]}</span>
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${project}</span>
                <span class="opacity-90">$${e.amount || ''}</span>
                ${e.note ? `<span class="opacity-70"> Â· ${e.note}</span>` : ''}
              `;
              frag.appendChild(row);
              rendered++;
            }
          }
        }
        list.innerHTML = '';
        list.appendChild(frag);
        if(!rendered) list.textContent = 'è¯¥è½¦æš‚æ— è´¹ç”¨è®°å½•';
      }catch{
        list.textContent = 'è®°å½•åŠ è½½å¤±è´¥';
      }
    }

    /* ==================== åˆå§‹åŒ– ==================== */
    (async function init(){
      try{ await loadDatesFromSheet4(); }catch{}
      try{ await loadCarsForB(); }catch{}
    })();
  </script>
</body>
</html>
