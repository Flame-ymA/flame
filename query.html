<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SJ Auto · 查询</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{ extend:{
        colors:{ sjgold:'#FFD700' },
        boxShadow:{ soft:'0 6px 24px rgba(255,215,0,0.08), 0 2px 8px rgba(0,0,0,0.25)' }
      } }
    }
  </script>
</head>
<body class="min-h-screen bg-black text-sjgold/90 antialiased">
  <!-- 顶部 -->
  <header class="sticky top-0 z-10 bg-black/70 backdrop-blur border-b border-sjgold/20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-sjgold/10 ring-1 ring-sjgold/20">📊</span>
        <h1 class="text-lg sm:text-xl font-semibold tracking-wide">查询 · 费用 & 照片</h1>
      </div>
      <nav class="text-sm flex gap-3">
        <a href="index.html" class="px-3 py-1.5 rounded-lg border border-sjgold/30 hover:bg-zinc-900">录入</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- 模式切换 -->
    <div class="flex gap-3">
      <button id="tabByDate" class="px-4 h-10 rounded-xl border border-sjgold/30 bg-sjgold text-black font-medium shadow-soft">按日期</button>
      <button id="tabByCar"  class="px-4 h-10 rounded-xl border border-sjgold/30 hover:bg-zinc-900">按车型</button>
    </div>

    <!-- ================= 按日期 ================= -->
    <section id="panelDate" class="bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="flex items-end flex-wrap gap-3">
        <div>
          <label class="block text-sm opacity-80">选择日期</label>
          <input id="dateHdrRawA" type="date"
                 class="mt-1 bg-black/60 border border-sjgold/30 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-yellow-500"/>
        </div>
        <div>
          <label class="block text-sm opacity-80">费用类别（可选）</label>
          <select id="catFilterA" class="mt-1 rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 text-sm outline-none">
            <option value="">（全部）</option>
            <option>税前买入金额</option>
            <option>买断金额（lease）</option>
            <option>车主证过户费用</option>
            <option>转lease费用/买断费用</option>
            <option>检修费用</option>
            <option>加油费用</option>
            <option>上牌费用</option>
            <option>银行手续费</option>
            <option>客户返佣</option>
            <option>中介返佣</option>
            <option>员工激励</option>
          </select>
        </div>
        <button id="btnLoadA"
                class="ml-auto px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">
          加载
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <h2 class="text-sm mb-2 opacity-80">记录</h2>
          <div id="listA" class="space-y-2"></div>
        </div>
        <div>
          <h2 class="text-sm mb-2 opacity-80">图片</h2>
          <div id="picsA" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
      <div id="msgA" class="text-xs opacity-75"></div>
    </section>

    <!-- ================= 按车型 ================= -->
    <section id="panelCar" class="hidden bg-neutral-950/70 rounded-2xl ring-1 ring-sjgold/20 p-5 space-y-5">
      <div class="flex items-end gap-3">
        <div class="flex-1">
          <label class="block text-sm opacity-80">选择车型（来自 Sheet5）</label>
          <select id="carSelectB" class="mt-1 w-full rounded-lg bg-black/60 border border-sjgold/30 px-3 py-2 text-sm outline-none"></select>
        </div>
        <button id="btnLoadB"
                class="px-5 h-10 rounded-lg bg-sjgold text-black font-semibold hover:brightness-95">
          加载
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div>
          <h2 class="text-sm mb-2 opacity-80">该车费用记录</h2>
          <div id="listB" class="space-y-2"></div>
        </div>
        <div>
          <h2 class="text-sm mb-2 opacity-80">该车所有照片</h2>
          <div id="picsB" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-2"></div>
        </div>
      </div>
      <div id="msgB" class="text-xs opacity-75"></div>
    </section>
  </main>

  <script>
    /* ============ 配置 ============ */
    const BACKEND = 'https://flameauto-write.onrender.com';
    const CLOUDINARY_CLOUD_NAME = 'duwckagtg';

    /* ============ 工具函数 ============ */
    const toSlug = (s) => {
      if (!s) return '';
      let t = String(s).trim();
      t = t.normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
           .replace(/\s+/g, '-').replace(/[&:：、，,.;。\/\\]+/g, '-')
           .toLowerCase();
      t = t.replace(/[^a-z0-9\u4e00-\u9fa5_-]/g, '-').replace(/-+/g, '-').replace(/(^-|-$)/g, '');
      return t || 'x';
    };
    const pad2 = n => String(n).padStart(2,'0');
    const getCol = (headers, candidates) => {
      const n = (s)=>String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
      const map = headers.map(h=>n(h));
      for (const c of candidates) { const i = map.indexOf(n(c)); if (i !== -1) return i; }
      return -1;
    };

    // 解析单元格：“车 | 金额 | 备注 || 车 | 金额 …”
    function parseCellEntries(cell) {
      const out = [];
      if (!cell) return out;
      String(cell).split('||').map(s=>s.trim()).filter(Boolean).forEach(one=>{
        const p = one.split('|').map(x=>x.trim());
        out.push({ car: p[0]||'', amount: p[1]||'', note: p[2]||'', raw: one });
      });
      return out;
    }

    // Cloudinary 代理搜索（新后端：expr）
    async function cloudSearchByExpr(expr, limit = 100){
      const url = `${BACKEND}/cloudinary-search?expr=${encodeURIComponent(expr)}&limit=${limit}`;
      const r = await fetch(url);
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error || `HTTP ${r.status}`);
      return j;
    }

    /* ============ Tab ============ */
    const tabByDate = document.getElementById('tabByDate');
    const tabByCar  = document.getElementById('tabByCar');
    const panelDate = document.getElementById('panelDate');
    const panelCar  = document.getElementById('panelCar');
    tabByDate.addEventListener('click', ()=>{ panelDate.classList.remove('hidden'); panelCar.classList.add('hidden'); });
    tabByCar .addEventListener('click', ()=>{ panelCar .classList.remove('hidden'); panelDate.classList.add('hidden'); });

    /* ============ 按日期 ============ */
    document.getElementById('btnLoadA').addEventListener('click', loadByDate);

    async function loadByDate(){
      const hdr = document.getElementById('dateHdrRawA').value; // YYYY-MM-DD
      const cat = document.getElementById('catFilterA').value;
      const list = document.getElementById('listA');
      const pics = document.getElementById('picsA');
      const msg  = document.getElementById('msgA');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';

      if (!hdr) { msg.textContent = '请选择日期'; return; }

      // 骨架加载
      pics.innerHTML = '<div class="col-span-full grid grid-cols-4 gap-2">'
        + Array.from({length:8}).map(()=>'<div class="h-24 rounded-lg bg-zinc-900 animate-pulse"></div>').join('')
        + '</div>';

      // 1) 取当日各项目文字记录
      let items = null;
      try{
        const r = await fetch(`${BACKEND}/sheet4-day?date=${encodeURIComponent(hdr)}`);
        const j = await r.json();
        if (r.ok && j.ok) items = j.items || [];
      }catch{}

      // 若后端没开 /sheet4-day，则兜底从 /sheet4 前端解析
      if (!items) {
        try{
          const r = await fetch(`${BACKEND}/sheet4`);
          const j = await r.json();
          const values = j.values || [];
          if (!values.length) throw new Error('Sheet4 为空');

          const header = values[0] || [];
          // 表头里允许 “9/1、9月1日、09-01…”：构造候选
          const d = new Date(hdr);
          const m = d.getMonth()+1, day = d.getDate();
          const candidates = new Set([
            `${m}/${day}`, `${pad2(m)}/${pad2(day)}`,
            `${m}-${day}`, `${pad2(m)}-${pad2(day)}`,
            `${m}.${day}`, `${pad2(m)}.${pad2(day)}`,
            `${m}月${day}日`
          ]);

          let colIndex = -1;
          for (let c=1;c<header.length;c++) {
            const cell = String(header[c]||'').trim();
            if (candidates.has(cell)) { colIndex = c; break; }
          }
          if (colIndex === -1) throw new Error('未找到该日期列');

          items = [];
          for (let rIdx=1;rIdx<values.length;rIdx++) {
            items.push({ project: values[rIdx]?.[0] || '', value: values[rIdx]?.[colIndex] || '' });
          }
        }catch(e){
          msg.textContent = '读取日期记录失败';
        }
      }

      // 类别筛选
      if (cat) items = (items||[]).filter(x => String(x.project).trim() === String(cat).trim());

      // 2) 左侧渲染文字
      let rec = 0;
      for (const it of (items||[])) {
        for (const e of parseCellEntries(it.value)) {
          const div = document.createElement('div');
          div.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
          const amount = e.amount ? ` · $${e.amount}` : '';
          const note   = e.note   ? ` · ${e.note}` : '';
          div.innerHTML = `
            <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${it.project}</span>
            <span class="opacity-90">${e.car || '(无车型)'}${amount}${note}</span>
          `;
          list.appendChild(div);
          rec++;
        }
      }
      if (!rec) list.innerHTML = '<div class="text-xs opacity-70">该日期 / 类别下暂无记录</div>';

      // 3) 右侧按“日期”查图片：public_id:*__YYYY-MM-DD__*
      try{
        const expr = `public_id="*__${hdr}__*"`;
        const res = await cloudSearchByExpr(expr, 200);
        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const a = document.createElement('a');
          a.href = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
          a.target = '_blank'; a.rel = 'noopener';
          const el = document.createElement('img');
          el.src = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_600,h_420,q_auto,f_auto/${img.public_id}.jpg`;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
          a.appendChild(el);
          pics.appendChild(a);
        });
        if (!pics.children.length) pics.innerHTML = '<div class="text-xs opacity-70">未找到该日期的照片</div>';
      }catch(e){
        pics.innerHTML = '<div class="text-xs opacity-70">图片加载失败</div>';
      }
    }

    /* ============ 按车型 ============ */
    // 载入车型列表（Sheet5）
    (async function loadCarsForB(){
      try{
        const r = await fetch(`${BACKEND}/sheet5`);
        const { ok, values=[] } = await r.json();
        if (!ok || !values.length) throw new Error('Sheet5 为空');

        const [header, ...rows] = values;
        const stockIdx = getCol(header, ['StockID','Stockid','Stock Id','Stock Id.']);
        const yearIdx  = getCol(header, ['Year']);
        const makeIdx  = getCol(header, ['Make','Brand']);
        const modelIdx = getCol(header, ['Model']);

        const sel = document.getElementById('carSelectB');
        rows.forEach(row=>{
          const stock = row[stockIdx] || '';
          if (!stock) return;
          const year  = row[yearIdx]  || '';
          const make  = row[makeIdx]  || '';
          const model = row[modelIdx] || '';
          const label = `${stock} ${year} ${make} ${model}`.trim();
          const opt = document.createElement('option');
          opt.value = JSON.stringify({stock,year,make,model,label});
          opt.textContent = `${stock} · ${year} ${make} ${model}`;
          sel.appendChild(opt);
        });
      }catch{
        document.getElementById('carSelectB').innerHTML = '<option>加载失败</option>';
      }
    })();

    document.getElementById('btnLoadB').addEventListener('click', loadByCar);

    async function loadByCar(){
      const val = document.getElementById('carSelectB').value;
      const list = document.getElementById('listB');
      const pics = document.getElementById('picsB');
      const msg  = document.getElementById('msgB');
      list.innerHTML = ''; pics.innerHTML = ''; msg.textContent = '';
      if (!val) { msg.textContent = '请选择车型'; return; }
      const car = JSON.parse(val);

      // 右：按前缀 public_id: <stock>_<year>_<make>_<model>__*
      try{
        const prefix = `${toSlug(car.stock)}_${toSlug(car.year)}_${toSlug(car.make)}_${toSlug(car.model)}__`;
        const expr = `public_id="${prefix}*"`;
        // 骨架
        pics.innerHTML = '<div class="col-span-full grid grid-cols-4 gap-2">'
          + Array.from({length:8}).map(()=>'<div class="h-24 rounded-lg bg-zinc-900 animate-pulse"></div>').join('')
          + '</div>';
        const res = await cloudSearchByExpr(expr, 300);
        pics.innerHTML = '';
        (res.resources || []).forEach(img=>{
          const a = document.createElement('a');
          a.href = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${img.public_id}.jpg`;
          a.target = '_blank'; a.rel = 'noopener';
          const el = document.createElement('img');
          el.src = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/c_fill,w_600,h_420,q_auto,f_auto/${img.public_id}.jpg`;
          el.alt = img.public_id;
          el.className = 'w-full h-28 object-cover rounded-lg border border-sjgold/20 hover:opacity-90 transition';
          a.appendChild(el);
          pics.appendChild(a);
        });
        if (!pics.children.length) pics.innerHTML = '<div class="text-xs opacity-70">该车暂无照片</div>';
      }catch{
        pics.innerHTML = '<div class="text-xs opacity-70">图片加载失败</div>';
      }

      // 左：从 Sheet4 扫描该车的所有记录
      try{
        let values;
        try {
          const rr = await fetch(`${BACKEND}/sheet4`);
          const jj = await rr.json();
          values = jj.values || [];
        } catch {}
        if (!values || !values.length) { list.textContent = 'Sheet4 为空'; return; }

        const header = values[0] || [];
        const dateHeaders = header.slice(1).map(h => String(h||'').trim());
        const carKey = `${car.stock} ${car.year} ${car.make} ${car.model}`.trim().toLowerCase();

        // 骨架
        list.innerHTML = Array.from({length:4}).map(()=>(
          '<div class="rounded-lg border border-sjgold/10 p-2 bg-zinc-900 animate-pulse h-10"></div>'
        )).join('');

        let rendered = 0;
        const frag = document.createDocumentFragment();
        for (let r=1; r<values.length; r++) {
          const project = (values[r][0]||'').trim();
          for (let c=1; c<header.length; c++) {
            const entries = parseCellEntries(values[r][c] || '');
            const mine = entries.filter(e => (e.car||'').trim().toLowerCase() === carKey);
            for (const e of mine) {
              const row = document.createElement('div');
              row.className = 'rounded-lg border border-sjgold/20 p-2 text-sm bg-black/40';
              row.innerHTML = `
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${dateHeaders[c-1]}</span>
                <span class="px-2 py-0.5 mr-2 rounded bg-sjgold/15 text-[11px] ring-1 ring-sjgold/30">${project}</span>
                <span class="opacity-90">$${e.amount || ''}</span>
                ${e.note ? `<span class="opacity-70"> · ${e.note}</span>` : ''}
              `;
              frag.appendChild(row);
              rendered++;
            }
          }
        }
        list.innerHTML = '';
        list.appendChild(frag);
        if (!rendered) list.textContent = '该车暂无费用记录';
      }catch{
        list.textContent = '记录加载失败';
      }
    }

    /* ============ 默认：给日期控件一个今天 ============ */
    (function setToday(){
      const t = new Date();
      const val = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
      const input = document.getElementById('dateHdrRawA');
      if (!input.value) input.value = val;
    })();
  </script>
</body>
</html>
